fileTypes: ["sd"]
keyEquivalent: ^~S
indentUnit: "  "
name: Sparkdown
scopeName: text.source.sparkdown
uuid: E26C862D-2A5E-4F10-B0C3-D6BCB838CB7F
flags: mu

variables:
  INTEGER: "[0-9]+"
  NUMBER: (?:[-]?(?:\d*[.])?\d+)
  IDENTIFIER_START_CHAR: '_\p{L}'
  IDENTIFIER_END_CHAR: '0-9_\p{L}-'
  IDENTIFIER_START: "[{{IDENTIFIER_START_CHAR}}]"
  IDENTIFIER_END: "[{{IDENTIFIER_END_CHAR}}]*"
  IDENTIFIER: "{{IDENTIFIER_START}}{{IDENTIFIER_END}}"
  STRICT_PROPERTY_IDENTIFIER: (?:{{INTEGER}}|{{IDENTIFIER}}|{{QUOTED_STRING}})
  BEFORE_KEYWORD: (?<![{{IDENTIFIER_END_CHAR}}])(?:(?<=\.\.\.)|(?<!\.))
  AFTER_KEYWORD: (?![{{IDENTIFIER_END_CHAR}}])(?:(?=\.\.\.)|(?!\.))
  TAG_START: (?:[#]+(?:$|{{WS}}+))
  COMMENT_START: (?:[/][/]|[/][*])
  BREAK: (?:{{WS}}+[>]{{WS}}*)
  # Word
  WORD: (?:[\p{L}\p{N}\p{Mn}']+)
  # Whitespace
  WS: '[^\S\n\r]'
  # End Of Line
  EOL: "(?:$|{{WS}}*$|{{WS}}*{{TAG_START}}.*$|{{WS}}*[/][/].*$)"
  # Strict End Of Property Line (# tags are not allowed in property declarations, so no need to check for it)
  EOPL: "(?:$|{{WS}}*$|{{WS}}*[/][/].*$)"
  # Keyword Terminator
  KEYWORD_TERMINATOR: "(?:[:]|{{TAG_START}}|{{COMMENT_START}})"
  # End Of Keyword
  EOK: "(?:$|{{WS}}+|(?={{KEYWORD_TERMINATOR}}))"
  COMPARISON_OPERATOR: (?:[~]|[|]|[\^]|[$]|[*])
  QUOTED_STRING: (?:["](?:\\.|[^"\r\n])*["])
  UNQUOTED_STRING_TERMINATOR: (?:$|[\s"'`<>=:(){}\[\]]|{{COMMENT_START}})
  UNQUOTED_STRING_VALUE: (?:.*?)(?={{UNQUOTED_STRING_TERMINATOR}})
  PROPERTY_NAME_TERMINATOR: (?:[:]|[=]|[\r\n])
  ASSIGN_EQUAL_OPERATOR: (?:{{WS}}*[=]{{WS}}*)
  ARRAY_ITEM_OPERATOR: (?:[-](?:$|{{WS}}+))
  IMAGE_CONTROL_KEYWORDS: ["show", "hide", "animate"]
  IMAGE_CLAUSE_KEYWORDS: ["over", "after", "with", "wait", "ease"]
  AUDIO_CONTROL_KEYWORDS: ["play", "stop", "fade", "queue", "await"]
  AUDIO_CLAUSE_KEYWORDS:
    ["over", "after", "to", "loop", "once", "mute", "unmute", "now"]
  CONDITIONAL_BLOCK_KEYWORDS:
    [
      "if",
      "elseif",
      "else",
      "match",
      "case",
      "stopping",
      "shuffle",
      "cycle",
      "once",
      "repeat",
      "for",
      "fill",
    ]
  OUTER_CONTROL_STATEMENT_KEYWORDS: ["if", "elseif", "match", "repeat", "in"]
  INNER_CONTROL_STATEMENT_KEYWORDS: ["case", "fill", "slot"]
  DECLARATION_KEYWORDS:
    [
      "include",
      "function",
      "store",
      "var",
      "const",
      "temp",
      "list",
      "define",
      "load",
      "scene",
      "branch",
      "screen",
      "component",
      "animation",
      "style",
      "theme",
    ]

patterns:
  - { include: "#EndOfLine" }
  - { include: "#Newline" }
  - { include: "#Annotation" }
  - { include: "#FrontMatter" }
  - { include: "#Todo" }
  - { include: "#Include" }
  - { include: "#Load" }
  - { include: "#Declaration" }
  - { include: "#Function" }
  - { include: "#Scene" }
  - { include: "#Branch" }
  - { include: "#Knot" }
  - { include: "#Stitch" }
  - { include: "#Divert" }
  - { include: "#Thread" }
  - { include: "#ReturnStatement" }
  - { include: "#TempDeclaration" }
  - { include: "#Logic" }
  - { include: "#Choice" }
  - { include: "#Gather" }
  - { include: "#Title" }
  - { include: "#Heading" }
  - { include: "#Transitional" }
  - { include: "#Write" }
  - { include: "#Dialogue" }
  - { include: "#AssetLine" }
  - { include: "#Action" }
  - { include: "#ConditionalBracedBlock" }
  - { include: "#ConditionalIndentedBlock" }
  - { include: "#Whitespace" }

repository:
  ########## Helpers ##########

  FileSeparator:
    match: ^([/]{4,})({{WS}}*)([^/\s]+)({{WS}}*)([/]{4,})({{WS}}*)$

  FileSplitter:
    match: ^((?:[/]{4,})(?:{{WS}}*)(?:[^/\s]+)(?:{{WS}}*)(?:[/]{4,})(?:{{WS}}*))$

  ########## Annotation ##########

  Annotation:
    patterns:
      - { include: "#Comment" }
      - { include: "#Tags" }

  ########## Comment ##########

  Comment:
    patterns:
      - { include: "#LineComment" }
      - { include: "#BlockComment" }

  LineComment:
    tag: lineComment
    name: comment.line.sd
    match: ({{WS}}*)([/][/])(.*?)$(\r\n|\r|\n)?
    captures:
      1:
        patterns:
          - { include: "#Whitespace" }
      2:
        name: punctuation.definition.comment.mark
      3:
        patterns:
          - { include: "#LineCommentContent" }
      4:
        patterns:
          - { include: "#Newline" }

  LineCommentContent:
    tag: definition(lineComment)
    name: punctuation.definition.comment.content.sd
    match: (.+$)

  BlockComment:
    tag: blockComment
    name: comment.block.sd
    begin: ({{WS}}*)([/][*])
    beginCaptures:
      1:
        patterns:
          - { include: "#Whitespace" }
      2:
        name: punctuation.definition.comment.mark
    patterns:
      - { include: "#Newline" }
      - { include: "#BlockCommentContent" }
    end: ([*][/])
    endCaptures:
      1:
        name: punctuation.definition.comment.mark

  BlockCommentContent:
    tag: definition(lineComment)
    name: punctuation.definition.comment.content.sd
    match: (.+?)(?=$|[*][/])

  ########## Tag ##########

  Tags:
    tag: docComment
    name: comment.line.sd entity.tag.sd
    begin: ({{WS}}*)(?={{TAG_START}})
    captures:
      1:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Tag" }
    end: (?=$)

  Tag:
    tag: docComment
    name: comment.line.sd entity.tag.sd
    match: ({{WS}}*)({{TAG_START}})(.*?)(?:(?={{TAG_START}})|$)
    captures:
      1:
        patterns:
          - { include: "#Whitespace" }
      2:
        tag: definition(docComment)
        name: punctuation.definition.comment.sd comment.line.sd entity.tag.begin.sd
      3:
        patterns:
          - { include: "#TagContent" }

  TagContent:
    tag: definition(docComment)
    name: punctuation.definition.comment.content.sd
    match: (.+?)(?=$|{{TAG_START}})

  ########## Todo ##########

  Todo:
    tag: docComment
    name: comment.line.sd entity.todo.sd
    begin: ({{WS}}*)(TODO:|todo:)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        tag: definition(docComment)
        name: constant.other entity.todo.begin.sd
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#TodoContent" }
    end: (?=$)

  TodoContent:
    tag: definition(docComment)
    name: punctuation.definition.comment.content.sd
    match: (.+$)

  ########## Include ##########

  Include:
    tag: meta
    name: meta.import.include.sd
    begin: ^({{WS}}*)(INCLUDE|include)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#IncludeKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#IncludeContent" }
    end: (?=$)

  IncludeKeyword:
    tag: controlKeyword
    name: keyword.control.definition.include.sd
    match: (.+)

  IncludeContent:
    tag: string
    name: string.include.sd
    match: (.+?)(?={{EOL}})

  ########## Load ##########

  Load:
    tag: meta
    name: meta.import.load.sd
    begin: ^({{WS}}*)(LOAD|load)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#LoadKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#LoadName" }
      - { include: "#Whitespace" }
    end: (?=$)

  LoadKeyword:
    tag: controlKeyword
    name: keyword.control.definition.load.sd
    match: (.+)

  LoadName:
    tag: variableName
    name: variable.other.constant.load.name.sd
    match: (\S+)

  ########## Declaration: VAR LIST CONST EXTERNAL DEFINE ##########

  Declaration:
    patterns:
      - { include: "#StoreDeclaration" }
      - { include: "#VarDeclaration" }
      - { include: "#ListDeclaration" }
      - { include: "#ConstDeclaration" }
      - { include: "#ExternalDeclaration" }
      - { include: "#DefineDeclaration" }

  StoreDeclaration:
    tag: meta
    name: storage.type.var.sd
    begin: ({{WS}}*)(store)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#StoreKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#VariableAssignment" }
    end: (?=$)

  StoreKeyword:
    tag: controlKeyword
    name: keyword.control.definition.var.sd
    match: (.+)

  VarDeclaration:
    tag: meta
    name: storage.type.var.sd
    begin: ({{WS}}*)(VAR|var)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#VarKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#VariableAssignment" }
    end: (?=$)

  VarKeyword:
    tag: controlKeyword
    name: keyword.control.definition.var.sd
    match: (.+)

  ListDeclaration:
    tag: meta
    name: storage.type.list.sd
    begin: ({{WS}}*)(LIST|list)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ListKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#ListTypeAssignment" }
    end: (?=$)

  ListKeyword:
    tag: controlKeyword
    name: keyword.control.definition.list.sd
    match: (.+)

  ConstDeclaration:
    tag: meta
    name: storage.type.const.sd
    begin: ({{WS}}*)(CONST|const)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ConstKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#VariableAssignment" }
    end: (?=$)

  ConstKeyword:
    tag: controlKeyword
    name: keyword.control.definition.const.sd
    match: (.+)

  ExternalDeclaration:
    tag: meta
    name: storage.type.external.sd
    begin: ({{WS}}*)(EXTERNAL|external)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ExternalKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#ExternalFunctionDeclaration" }
    end: (?=$)

  ExternalKeyword:
    tag: controlKeyword
    name: keyword.control.definition.external.sd
    match: (.+)

  ListTypeAssignment:
    begin: ({{IDENTIFIER}})($|{{ASSIGN_EQUAL_OPERATOR}}|(?={{EOL}}))
    beginCaptures:
      1:
        patterns:
          - { include: "#ListTypeDeclarationName" }
      2:
        patterns:
          - { include: "#AssignEqualOperator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Expression" }
    end: (?=$)

  VariableAssignment:
    begin: ({{IDENTIFIER}})($|{{ASSIGN_EQUAL_OPERATOR}}|(?={{EOL}}))
    beginCaptures:
      1:
        patterns:
          - { include: "#VariableDeclarationName" }
      2:
        patterns:
          - { include: "#AssignEqualOperator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Divert" }
      - { include: "#Expression" }
    end: (?=$)

  ExternalFunctionDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#FunctionName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$)

  RefModifier:
    match: (ref)({{WS}}*)
    captures:
      1:
        tag: modifier
        name: storage.modifier.ref.sd
      2:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  FunctionDeclarationParameters:
    brackets: true
    begin: ([(])({{WS}}*)
    beginCaptures:
      1:
        tag: keyword
        name: punctuation.definition.template-expression.begin.sd
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Separator" }
      - { include: "#PunctuationComma" }
      - { include: "#Parameter" }
    end: $|({{WS}}*)([)])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        tag: keyword
        name: punctuation.definition.template-expression.end.sd

  FunctionCallParameters:
    brackets: true
    begin: ([(])({{WS}}*)
    beginCaptures:
      1:
        tag: keyword
        name: punctuation.definition.template-expression.begin.sd
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Separator" }
      - { include: "#PunctuationComma" }
      - { include: "#Parameter" }
    end: $|({{WS}}*)([)])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        tag: keyword
        name: punctuation.definition.template-expression.end.sd

  Parameter:
    tag: meta
    name: meta.parameter.sd
    begin: (?=.+$)
    patterns:
      - { include: "#Comment" }
      - { include: "#Expression" }
    end: $|(?={{WS}}*(?:[)]|[,]))

  DefineDeclaration:
    patterns:
      - { include: "#DefineViewDeclaration" }
      - { include: "#DefineStylingDeclaration" }
      - { include: "#DefinePlainDeclaration" }

  DefineViewDeclaration:
    tag: meta
    name: meta.definition.type.define.sd
    begin: ({{WS}}*)(define)({{EOK}})(?=(?:screen|component){{EOK}})(.*?)$
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#DefineKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#DefineAssignment" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#ViewStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  DefineStylingDeclaration:
    tag: meta
    name: meta.definition.type.define.sd
    begin: ({{WS}}*)(define)({{EOK}})(?=(?:style|animation|theme){{EOK}})(.*?)$
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#DefineKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#DefineAssignment" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#StylingStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  DefinePlainDeclaration:
    tag: meta
    name: meta.definition.type.define.sd
    begin: ({{WS}}*)(define)({{EOK}})(.*?)$
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#DefineKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#DefineAssignment" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#PlainStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  DefineKeyword:
    tag: controlKeyword
    name: keyword.control.definition.object.sd
    match: (.+)

  DefineAssignment:
    match: (.*?)([(].*[)])?(?:(with)((?=$|[:])|{{WS}}+)((?=$|[:])|{{IDENTIFIER}}))?({{WS}}*)($|[:])
    captures:
      1:
        patterns:
          - { include: "#DefineIdentifier" }
      2:
        patterns:
          - { include: "#FunctionDeclarationParameters" }
      3:
        patterns:
          - { include: "#WithKeyword" }
      4:
        patterns:
          - { include: "#Separator" }
      5:
        patterns:
          - { include: "#DefineModifierName" }
      6:
        patterns:
          - { include: "#ExtraWhitespace" }
      7:
        patterns:
          - { include: "#ColonOperator" }

  DefineIdentifier:
    match: ({{IDENTIFIER}})($|{{WS}}+)($|{{IDENTIFIER}})($|.+)
    captures:
      1:
        patterns:
          - { include: "#DefineTypeName" }
      2:
        patterns:
          - { include: "#DefinePunctuationAccessor" }
      3:
        patterns:
          - { include: "#DefineVariableName" }
      4:
        patterns:
          - { include: "#Other" }

  WithKeyword:
    tag: controlKeyword
    name: keyword.control.define.with.sd
    match: (.+)

  DefineModifierName:
    tag: keyword
    name: storage.modifier.sd
    match: (.+)

  DefineTypeName:
    tag: typeName
    name: support.type.define.sd
    match: (.+)

  DefinePunctuationAccessor:
    match: ({{WS}})
    tag: separator
    name: meta.template.expression.accessor.sd

  DefineVariableName:
    tag: variableName
    name: variable.other.constant.sd
    match: (.+)

  BlankProperty:
    match: ^({{WS}}+$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }

  ViewStructField:
    emit: true
    patterns:
      - { include: "#BlankProperty" }
      - { include: "#ViewStructObjectItem" }
      - { include: "#ViewStructScalarItem" }
      - { include: "#ViewStructScalarProperty" }
      - { include: "#ViewStructObjectProperty" }
      - { include: "#Newline" }

  StylingStructField:
    emit: true
    patterns:
      - { include: "#BlankProperty" }
      - { include: "#StylingStructObjectItem" }
      - { include: "#StylingStructScalarItem" }
      - { include: "#StylingStructScalarProperty" }
      - { include: "#StylingStructObjectProperty" }
      - { include: "#Newline" }

  PlainStructField:
    emit: true
    patterns:
      - { include: "#BlankProperty" }
      - { include: "#PlainStructObjectItem" }
      - { include: "#PlainStructScalarItem" }
      - { include: "#PlainStructScalarProperty" }
      - { include: "#PlainStructObjectProperty" }
      - { include: "#Newline" }

  ViewStructObjectItem:
    patterns:
      - { include: "#ViewStructObjectItemBlock" }
      - { include: "#ViewStructObjectItemWithInlineScalarProperty" }
      - { include: "#ViewStructObjectItemWithInlineObjectProperty" }

  StylingStructObjectItem:
    patterns:
      - { include: "#StylingStructObjectItemBlock" }
      - { include: "#StylingStructObjectItemWithInlineScalarProperty" }
      - { include: "#StylingStructObjectItemWithInlineObjectProperty" }

  PlainStructObjectItem:
    patterns:
      - { include: "#PlainStructObjectItemBlock" }
      - { include: "#PlainStructObjectItemWithInlineScalarProperty" }
      - { include: "#PlainStructObjectItemWithInlineObjectProperty" }

  ViewStructObjectItemBlock:
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{EOPL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#EndOfLine" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#ViewStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  StylingStructObjectItemBlock:
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{EOPL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#EndOfLine" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#StylingStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  PlainStructObjectItemBlock:
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{EOPL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#EndOfLine" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#PlainStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  ViewStructObjectItemWithInlineScalarProperty:
    tag: meta
    name: meta.definition.struct.item.object.sd
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{STRICT_PROPERTY_IDENTIFIER}})({{ASSIGN_EQUAL_OPERATOR}})(.*$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#ViewDeclarationScalarPropertyName" }
      4:
        patterns:
          - { include: "#AssignEqualOperator" }
      5:
        patterns:
          - { include: "#StylingStructFieldValue" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#ViewStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  StylingStructObjectItemWithInlineScalarProperty:
    tag: meta
    name: meta.definition.struct.item.object.sd
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{STRICT_PROPERTY_IDENTIFIER}})({{ASSIGN_EQUAL_OPERATOR}})(.*$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#StylingDeclarationScalarPropertyName" }
      4:
        patterns:
          - { include: "#AssignEqualOperator" }
      5:
        patterns:
          - { include: "#StylingStructFieldValue" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#StylingStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  PlainStructObjectItemWithInlineScalarProperty:
    tag: meta
    name: meta.definition.struct.item.object.sd
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{STRICT_PROPERTY_IDENTIFIER}})({{ASSIGN_EQUAL_OPERATOR}})(.*$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#PlainDeclarationScalarPropertyName" }
      4:
        patterns:
          - { include: "#AssignEqualOperator" }
      5:
        patterns:
          - { include: "#PlainStructFieldValue" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#PlainStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  ViewStructObjectItemWithInlineObjectProperty:
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{STRICT_PROPERTY_IDENTIFIER}})({{WS}}*)([:])({{WS}}*)(.*$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#ViewDeclarationObjectPropertyName" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
      5:
        patterns:
          - { include: "#ColonOperator" }
      6:
        patterns:
          - { include: "#ExtraWhitespace" }
      7:
        patterns:
          - { include: "#Comment" }
          - { include: "#IllegalChar" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#ViewStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  StylingStructObjectItemWithInlineObjectProperty:
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{STRICT_PROPERTY_IDENTIFIER}})({{WS}}*)([:])({{WS}}*)(.*$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#StylingDeclarationObjectPropertyName" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
      5:
        patterns:
          - { include: "#ColonOperator" }
      6:
        patterns:
          - { include: "#ExtraWhitespace" }
      7:
        patterns:
          - { include: "#Comment" }
          - { include: "#IllegalChar" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#StylingStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  PlainStructObjectItemWithInlineObjectProperty:
    begin: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})({{STRICT_PROPERTY_IDENTIFIER}})({{WS}}*)([:])({{WS}}*)(.*$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#PlainDeclarationObjectPropertyName" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
      5:
        patterns:
          - { include: "#ColonOperator" }
      6:
        patterns:
          - { include: "#ExtraWhitespace" }
      7:
        patterns:
          - { include: "#Comment" }
          - { include: "#IllegalChar" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#PlainStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  ViewStructScalarItem:
    match: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})(.*$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#ViewStructFieldValue" }

  StylingStructScalarItem:
    match: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})(.*$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#StylingStructFieldValue" }

  PlainStructScalarItem:
    match: ^({{WS}}*)({{ARRAY_ITEM_OPERATOR}})(.*$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ArrayItemOperator" }
      3:
        patterns:
          - { include: "#PlainStructFieldValue" }

  ViewStructScalarProperty:
    match: ^({{WS}}*)({{STRICT_PROPERTY_IDENTIFIER}})({{ASSIGN_EQUAL_OPERATOR}})(.*$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ViewDeclarationScalarPropertyName" }
      3:
        patterns:
          - { include: "#AssignEqualOperator" }
      4:
        patterns:
          - { include: "#ViewStructFieldValue" }

  StylingStructScalarProperty:
    match: ^({{WS}}*)({{STRICT_PROPERTY_IDENTIFIER}})({{ASSIGN_EQUAL_OPERATOR}})(.*$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#StylingDeclarationScalarPropertyName" }
      3:
        patterns:
          - { include: "#AssignEqualOperator" }
      4:
        patterns:
          - { include: "#StylingStructFieldValue" }

  PlainStructScalarProperty:
    match: ^({{WS}}*)({{STRICT_PROPERTY_IDENTIFIER}})({{ASSIGN_EQUAL_OPERATOR}})(.*$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#PlainDeclarationScalarPropertyName" }
      3:
        patterns:
          - { include: "#AssignEqualOperator" }
      4:
        patterns:
          - { include: "#PlainStructFieldValue" }

  ViewStructObjectProperty:
    begin: ^({{WS}}*)(.+$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ViewDeclarationObjectPropertyAssignment" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#ViewStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  StylingStructObjectProperty:
    begin: ^({{WS}}*)(.+$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#PlainDeclarationObjectPropertyAssignment" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#StylingStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  PlainStructObjectProperty:
    begin: ^({{WS}}*)(.+$)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#PlainDeclarationObjectPropertyAssignment" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Newline" }
      - { include: "#PlainStructField" }
      - { include: "#Unknown" }
    end: (?=^(?!$|//|\1{{WS}}))

  ViewDeclarationObjectPropertyAssignment:
    begin: (?=\S)
    patterns:
      - { include: "#Comment" }
      - { include: "#ViewForControlProperty" }
      - { include: "#ViewControlProperty" }
      - { include: "#ViewDeclarationObjectPropertyName" }
    applyEndPatternLast: true
    end: $|({{WS}}*)([:])({{WS}}*)(.*$)|(.+$)
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#ColonOperator" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#Comment" }
          - { include: "#IllegalChar" }
      5:
        patterns:
          - { include: "#Comment" }
          - { include: "#IllegalChar" }

  PlainDeclarationObjectPropertyAssignment:
    begin: (?=\S)
    patterns:
      - { include: "#Comment" }
      - { include: "#PlainDeclarationObjectPropertyName" }
    applyEndPatternLast: true
    end: $|({{WS}}*)([:])({{WS}}*)(.*$)|(.+$)
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#ColonOperator" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#Comment" }
          - { include: "#IllegalChar" }
      5:
        patterns:
          - { include: "#Comment" }
          - { include: "#IllegalChar" }

  ViewDeclarationObjectPropertyName:
    begin: (?=\S)(?!{{PROPERTY_NAME_TERMINATOR}})
    patterns:
      - { include: "#Comment" }
      - { include: "#SelectorPropertyNamePart" }
      - { include: "#ComponentName" }
      - { include: "#IllegalChar" }
    end: (?=$|{{EOPL}}|{{WS}}*{{PROPERTY_NAME_TERMINATOR}})

  StylingDeclarationObjectPropertyName:
    begin: (?=\S)(?!{{PROPERTY_NAME_TERMINATOR}})
    patterns:
      - { include: "#Comment" }
      - { include: "#OperatorPrefixedPropertyName" }
      - { include: "#PropertyName" }
      - { include: "#InvalidSelectorPropertyName" }
    end: (?=$|{{EOPL}}|{{WS}}*{{PROPERTY_NAME_TERMINATOR}})

  PlainDeclarationObjectPropertyName:
    begin: (?=\S)(?!{{PROPERTY_NAME_TERMINATOR}})
    patterns:
      - { include: "#Comment" }
      - { include: "#OperatorPrefixedPropertyName" }
      - { include: "#PropertyName" }
      - { include: "#InvalidSelectorPropertyName" }
    end: (?=$|{{EOPL}}|{{WS}}*{{PROPERTY_NAME_TERMINATOR}})

  OperatorPrefixedPropertyName:
    begin: (?=\S)(?!{{IDENTIFIER}})(?!{{PROPERTY_NAME_TERMINATOR}})
    patterns:
      - { include: "#Comment" }
      - { include: "#SelectorPropertyNamePart" }
      - { include: "#ComponentName" }
      - { include: "#IllegalChar" }
    end: (?=$|{{EOPL}}|{{WS}}*{{PROPERTY_NAME_TERMINATOR}})

  InvalidSelectorPropertyName:
    tag: invalid
    name: invalid.illegal.unknown-statement.sd
    begin: (?=\S)(?!{{PROPERTY_NAME_TERMINATOR}})
    patterns:
      - { include: "#Comment" }
      - { include: "#SelectorPropertyNamePart" }
      - { include: "#ComponentName" }
      - { include: "#IllegalChar" }
    end: (?=$|{{EOPL}}|{{WS}}*{{PROPERTY_NAME_TERMINATOR}})

  SelectorPropertyNamePart:
    patterns:
      - { include: "#ParenPropertyIdentifierString" }
      - { include: "#BracketPropertyIdentifierString" }
      - { include: "#BracePropertyIdentifierString" }
      - { include: "#UnitValue" }
      - { include: "#Literal" }
      - { include: "#SelectorOperator" }
      - { include: "#RecursiveSelectorFunction" }
      - { include: "#SimpleSelectorFunction" }
      - { include: "#StyleAttribute" }
      - { include: "#EventAttribute" }
      - { include: "#LabelAttribute" }
      - { include: "#Separator" }

  ParenPropertyIdentifierString:
    brackets: true
    begin: ([(])({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationParenOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#SelectorPropertyNamePart" }
    end: $|({{WS}}*)([)])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#PunctuationParenClose" }

  BracketPropertyIdentifierString:
    brackets: true
    begin: (\[)({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationBracketOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#SelectorPropertyNamePart" }
    end: $|({{WS}}*)(\])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#PunctuationBracketClose" }

  BracePropertyIdentifierString:
    brackets: true
    begin: (\{)({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationBraceOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#SelectorPropertyNamePart" }
    end: $|({{WS}}*)(\})
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#PunctuationBraceClose" }

  UnitValue:
    match: ([-]?(?:\d*[.])?\d+)([%]|[a-zA-Z]+)
    captures:
      1:
        tag: number
        name: constant.numeric.amount.sd
      2:
        tag: number
        name: constant.numeric.unit.sd

  SelectorOperator:
    tag: keyword
    name: keyword.other.selector.operator.sd
    match: ([>]|[+]|[~]|[*]|[&]|[\^])

  RecursiveSelectorFunction:
    begin: ([@])(has|not|is|where)(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "#EventAttributeOperator" }
      2:
        patterns:
          - { include: "#EventAttributeName" }
    patterns:
      - { include: "#Comment" }
      - { include: "#RecursiveSelectorFunctionParameters" }
    applyEndPatternLast: true
    end: (?=$|.)

  RecursiveSelectorFunctionParameters:
    brackets: true
    begin: ([(])({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationParenOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#SelectorPropertyNamePart" }
      - { include: "#ComponentName" }
      - { include: "#IllegalChar" }
    end: $|({{WS}}*)([)])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#PunctuationParenClose" }

  SimpleSelectorFunction:
    begin: ([@])({{IDENTIFIER}})?(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "#EventAttributeOperator" }
      2:
        patterns:
          - { include: "#EventAttributeName" }
    patterns:
      - { include: "#Comment" }
      - { include: "#SimpleSelectorFunctionParameters" }
    applyEndPatternLast: true
    end: (?=$|.)

  SimpleSelectorFunctionParameters:
    brackets: true
    begin: ([(])({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationParenOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#SelectorPropertyNamePart" }
      - { include: "#StringIdentifier" }
      - { include: "#IllegalChar" }
    end: $|({{WS}}*)([)])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#PunctuationParenClose" }

  StyleAttribute:
    emit: true
    patterns:
      - { include: "#AssignedBracedStyleAttribute" }
      - { include: "#AssignedQuotedStyleAttribute" }
      - { include: "#AssignedUnquotedStyleAttribute" }
      - { include: "#UnassignedStyleAttribute" }

  EventAttribute:
    emit: true
    patterns:
      - { include: "#AssignedBracedEventAttribute" }
      - { include: "#AssignedQuotedEventAttribute" }
      - { include: "#AssignedUnquotedEventAttribute" }
      - { include: "#UnassignedEventAttribute" }

  AssignedBracedStyleAttribute:
    begin: ([#])({{IDENTIFIER}})?({{COMPARISON_OPERATOR}}?[=])([{])
    beginCaptures:
      1:
        patterns:
          - { include: "#StyleAttributeOperator" }
      2:
        patterns:
          - { include: "#StyleAttributeName" }
      3:
        patterns:
          - { include: "#AttributeEqualOperator" }
      4:
        patterns:
          - { include: "#PunctuationBraceOpen" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Expression" }
    end: ([}])
    endCaptures:
      1:
        patterns:
          - { include: "#PunctuationBraceClose" }

  AssignedQuotedStyleAttribute:
    tag: string
    name: string.quoted.double.view.sd
    begin: ([#])({{IDENTIFIER}})?({{COMPARISON_OPERATOR}}?[=])(["])
    beginCaptures:
      1:
        patterns:
          - { include: "#StyleAttributeOperator" }
      2:
        patterns:
          - { include: "#StyleAttributeName" }
      3:
        patterns:
          - { include: "#AttributeEqualOperator" }
      4:
        patterns:
          - { include: "#PunctuationStringOpen" }
    patterns:
      - { include: "#Comment" }
      - { include: "#StringContent" }
    end: $|(["])
    endCaptures:
      1:
        patterns:
          - { include: "#PunctuationStringClose" }

  AssignedUnquotedStyleAttribute:
    begin: ([#])({{IDENTIFIER}})?({{COMPARISON_OPERATOR}}?[=])
    beginCaptures:
      1:
        patterns:
          - { include: "#StyleAttributeOperator" }
      2:
        patterns:
          - { include: "#StyleAttributeName" }
      3:
        patterns:
          - { include: "#AttributeEqualOperator" }
    patterns:
      - { include: "#Comment" }
      - { include: "#UnquotedStyleAttributeValue" }
    end: (?={{UNQUOTED_STRING_TERMINATOR}})

  UnassignedStyleAttribute:
    match: ([#])({{IDENTIFIER}})?
    captures:
      1:
        patterns:
          - { include: "#StyleAttributeOperator" }
      2:
        patterns:
          - { include: "#StyleAttributeName" }

  AssignedBracedEventAttribute:
    begin: ([@])({{IDENTIFIER}})?({{COMPARISON_OPERATOR}}?[=])([{])
    beginCaptures:
      1:
        patterns:
          - { include: "#EventAttributeOperator" }
      2:
        patterns:
          - { include: "#EventAttributeName" }
      3:
        patterns:
          - { include: "#AttributeEqualOperator" }
      4:
        patterns:
          - { include: "#PunctuationBraceOpen" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Expression" }
    end: ([}])
    endCaptures:
      1:
        patterns:
          - { include: "#PunctuationBraceClose" }

  AssignedQuotedEventAttribute:
    tag: string
    name: string.quoted.double.view.sd
    begin: ([@])({{IDENTIFIER}})?({{COMPARISON_OPERATOR}}?[=])(["])
    beginCaptures:
      1:
        patterns:
          - { include: "#EventAttributeOperator" }
      2:
        patterns:
          - { include: "#EventAttributeName" }
      3:
        patterns:
          - { include: "#AttributeEqualOperator" }
      4:
        patterns:
          - { include: "#PunctuationStringOpen" }
    patterns:
      - { include: "#Comment" }
      - { include: "#StringContent" }
    end: $|(["])
    endCaptures:
      1:
        patterns:
          - { include: "#PunctuationStringClose" }

  AssignedUnquotedEventAttribute:
    begin: ([@])({{IDENTIFIER}})?({{COMPARISON_OPERATOR}}?[=])
    beginCaptures:
      1:
        patterns:
          - { include: "#EventAttributeOperator" }
      2:
        patterns:
          - { include: "#Comment" }
          - { include: "#EventAttributeName" }
      3:
        patterns:
          - { include: "#AttributeEqualOperator" }
    patterns:
      - { include: "#Comment" }
      - { include: "#UnquotedEventAttributeValue" }
    end: (?={{UNQUOTED_STRING_TERMINATOR}})

  UnassignedEventAttribute:
    match: ([@])({{IDENTIFIER}})?
    captures:
      1:
        patterns:
          - { include: "#EventAttributeOperator" }
      2:
        patterns:
          - { include: "#EventAttributeName" }

  StyleAttributeOperator:
    tag: variableName
    name: variable.other.constant.attribute.style.sd
    match: ([#])

  StyleAttributeName:
    tag: variableName
    name: variable.other.constant.attribute.style.sd
    match: (.+)

  UnquotedStyleAttributeValue:
    tag: string
    name: string.unquoted.attribute.value.sd
    match: ({{UNQUOTED_STRING_VALUE}})

  EventAttributeOperator:
    tag: function(variableName)
    name: entity.name.function.attribute.name.view.sd
    match: ([@])

  EventAttributeName:
    tag: function(variableName)
    name: entity.name.function.attribute.name.view.sd
    match: (.+)

  UnquotedEventAttributeValue:
    match: ({{UNQUOTED_STRING_VALUE}})
    captures:
      1:
        patterns:
          - { include: "#DivertTarget" }

  UnquotedStringValue:
    tag: string
    name: string.unquoted.attribute.value.sd
    match: ({{UNQUOTED_STRING_VALUE}})

  LabelAttribute:
    emit: true
    patterns:
      - { include: "#StringLiteral" }

  FunctionCall:
    begin: ({{IDENTIFIER}})({{WS}}*)(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "#FunctionName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#FunctionCallParameters" }
    applyEndPatternLast: true
    end: (?=$|.)

  FunctionAccessor:
    begin: ([.])?({{IDENTIFIER}})({{WS}}*)(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationAccessor" }
      2:
        patterns:
          - { include: "#FunctionName" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#FunctionCallParameters" }
    applyEndPatternLast: true
    end: (?=$|.)

  ArrayItemOperator:
    match: ([-])($|{{WS}}+)
    captures:
      1:
        patterns:
          - { include: "#ArrayItemMark" }
      2:
        patterns:
          - { include: "#Separator" }

  ArrayItemMark:
    tag: keyword
    name: keyword.operator.expression.array.sd
    match: (.+)

  AttributeEqualOperator:
    tag: operator
    name: keyword.operator.sd
    match: (.+)

  ViewStructFieldValue:
    match: (.+$)
    captures:
      1:
        patterns:
          - { include: "#Comment" }
          - { include: "#NumericFieldValue" }
          - { include: "#BooleanFieldValue" }
          - { include: "#StringFieldValue" }
          - { include: "#AccessPath" }
          - { include: "#UnquotedStringFieldValue" }

  StylingStructFieldValue:
    match: (.+$)
    captures:
      1:
        patterns:
          - { include: "#Comment" }
          - { include: "#NumericFieldValue" }
          - { include: "#BooleanFieldValue" }
          - { include: "#StringFieldValue" }
          - { include: "#StylingValue" }

  PlainStructFieldValue:
    match: (.+$)
    captures:
      1:
        patterns:
          - { include: "#Comment" }
          - { include: "#NumericFieldValue" }
          - { include: "#BooleanFieldValue" }
          - { include: "#StringFieldValue" }
          - { include: "#AccessPath" }
          - { include: "#UnquotedStringFieldValue" }

  NumericFieldValue:
    tag: number
    name: constant.numeric.sd
    match: ([-]?(?:\d*[.])?\d+|Infinity|NaN)({{EOPL}})
    captures:
      1:
        patterns:
          - { include: "#NumericLiteral" }
      2:
        patterns:
          - { include: "#EndOfLine" }

  BooleanFieldValue:
    tag: bool
    name: constant.language.boolean.true.sd
    match: (true|false)({{EOPL}})
    captures:
      1:
        patterns:
          - { include: "#BooleanLiteral" }
      2:
        patterns:
          - { include: "#EndOfLine" }

  StringFieldValue:
    tag: string
    name: string.quoted.double.sd
    match: (["])((?:\\.|[^"])*)(["])({{EOPL}})
    captures:
      1:
        patterns:
          - { include: "#PunctuationStringOpen" }
      2:
        patterns:
          - { include: "#StringEscape" }
          - { include: "#StringCharacter" }
      3:
        patterns:
          - { include: "#PunctuationStringClose" }
      4:
        patterns:
          - { include: "#EndOfLine" }

  UnquotedStringFieldValue:
    match: (.+)({{EOPL}})
    captures:
      1:
        patterns:
          - { include: "#UnquotedString" }
      2:
        patterns:
          - { include: "#EndOfLine" }

  UnquotedString:
    tag: string
    name: string.unquoted.sd
    match: (.+)

  StylingValue:
    match: (.+)({{EOPL}})
    captures:
      1:
        patterns:
          - { include: "#Comment" }
          - { include: "#StylingValuePart" }
      2:
        patterns:
          - { include: "#EndOfLine" }

  StylingValuePart:
    patterns:
      - { include: "#Separator" }
      - { include: "#Color" }
      - { include: "#Ratio" }
      - { include: "#UnitValue" }
      - { include: "#NumericLiteral" }
      - { include: "#PunctuationComma" }
      - { include: "#StylingFunction" }
      - { include: "#QualifiedAccessPath" }
      - { include: "#StringIdentifier" }
      - { include: "#UnquotedChar" }

  StylingFunction:
    begin: ({{IDENTIFIER}})({{WS}}*)(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "StylingFunctionName" }
      2:
        patterns:
          - { include: "ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#StylingFunctionParameters" }
    applyEndPatternLast: true
    end: (?=$|.)

  StylingFunctionParameters:
    brackets: true
    begin: ([(])({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "PunctuationParenOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#CalcOperator" }
      - { include: "#StylingValuePart" }
    end: $|({{WS}}*)([)])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "PunctuationParenClose" }

  StylingFunctionName:
    tag: function(variableName)
    name: entity.name.function.sd
    match: ({{IDENTIFIER}})

  StringIdentifier:
    tag: string
    name: string.unquoted.identifier.sd
    match: ({{IDENTIFIER}})

  UnquotedChar:
    tag: string
    name: string.unquoted.char.sd
    match: (.)

  CalcOperator:
    tag: keyword
    name: keyword.other.calc.operator.sd
    match: ([+]|[-]|[*]|[/])

  Ratio:
    match: ({{NUMBER}})({{WS}}*)([/])({{WS}}*)({{NUMBER}})
    captures:
      1:
        patterns:
          - { include: "#NumericLiteral" }
      2:
        patterns:
          - { include: "ExtraWhitespace" }
      3:
        patterns:
          - { include: "CalcOperator" }
      4:
        patterns:
          - { include: "ExtraWhitespace" }
      5:
        patterns:
          - { include: "NumericLiteral" }

  TargetAccessPath:
    emit: true
    patterns:
      - { include: "#AccessPath" }
      - { include: "#IllegalExpression" }

  QualifiedAccessPath:
    begin: (?={{IDENTIFIER}}[.])
    patterns:
      - { include: "#Comment" }
      - { include: "#AccessPath" }
    end: (?=$)|(?!{{IDENTIFIER}}|[.]|\[)

  AccessPath:
    begin: (?={{IDENTIFIER}})
    patterns:
      - { include: "#Comment" }
      - { include: "#AccessPart" }
    end: (?=$)|(?!{{IDENTIFIER}}|[.]|\[)

  AccessPart:
    emit: true
    patterns:
      - { include: "#ArrayLiteral" }
      - { include: "#FunctionAccessor" }
      - { include: "#PropertyAccessor" }
      - { include: "#NamespaceAccessor" }
      - { include: "#VariableName" }
      - { include: "#PunctuationAccessor" }

  ListTypeDeclarationName:
    emit: true
    patterns:
      - { include: "#TypeName" }
      - { include: "#Unknown" }

  VariableDeclarationName:
    emit: true
    patterns:
      - { include: "#VariableName" }
      - { include: "#Unknown" }

  ViewDeclarationScalarPropertyName:
    match: ({{STRICT_PROPERTY_IDENTIFIER}})
    captures:
      1:
        patterns:
          - { include: "#DeclarationScalarPropertyIndex" }
          - { include: "#DeclarationScalarPropertyQuotedKey" }
          - { include: "#ComponentName" }

  StylingDeclarationScalarPropertyName:
    match: ({{STRICT_PROPERTY_IDENTIFIER}})
    captures:
      1:
        patterns:
          - { include: "#DeclarationScalarPropertyIndex" }
          - { include: "#DeclarationScalarPropertyQuotedKey" }
          - { include: "#DeclarationScalarPropertyKey" }

  PlainDeclarationScalarPropertyName:
    match: ({{STRICT_PROPERTY_IDENTIFIER}})
    captures:
      1:
        patterns:
          - { include: "#DeclarationScalarPropertyIndex" }
          - { include: "#DeclarationScalarPropertyQuotedKey" }
          - { include: "#DeclarationScalarPropertyKey" }

  DeclarationScalarPropertyIndex:
    tag: number
    name: constant.numeric.integer.sd
    match: ({{INTEGER}})

  DeclarationScalarPropertyKey:
    tag: propertyName
    name: variable.other.property.define.sd
    match: ({{IDENTIFIER}})

  DeclarationScalarPropertyQuotedKey:
    tag: string
    name: string.quoted.key.sd
    match: ({{QUOTED_STRING}})

  ViewForControlProperty:
    match: ^({{WS}}*)(for)({{WS}}*)(.*?)($|{{WS}}+)($|in)($|{{WS}}+)(.*?)($|{{WS}}*)($|[:])($|{{WS}}*$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ViewDeclarationControlKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#ViewDeclarationAsExpression" }
      5:
        patterns:
          - { include: "#Separator" }
      6:
        patterns:
          - { include: "#InKeyword" }
      7:
        patterns:
          - { include: "#Separator" }
      8:
        patterns:
          - { include: "#ViewDeclarationControlExpression" }
      9:
        patterns:
          - { include: "#ExtraWhitespace" }
      10:
        patterns:
          - { include: "#ColonOperator" }
      11:
        patterns:
          - { include: "#ExtraWhitespace" }

  ViewControlProperty:
    match: ^({{WS}}*)({{CONDITIONAL_BLOCK_KEYWORDS}})({{WS}}*)(.*?)({{WS}}*)($|[:])($|{{WS}}*$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ViewDeclarationControlKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#ViewDeclarationControlExpression" }
      5:
        patterns:
          - { include: "#ExtraWhitespace" }
      6:
        patterns:
          - { include: "#ColonOperator" }
      7:
        patterns:
          - { include: "#ExtraWhitespace" }

  ComponentName:
    patterns:
      - { include: "#BuiltinComponentName" }
      - { include: "#CustomComponentName" }
      - { include: "#FunctionCallParameters" }

  BuiltinComponentName:
    tag: definitionKeyword
    name: keyword.other.component.builtin.name.sd
    match: \b(box|span|scroller|text|stroke|link|label|field|button|image|mask|input|slider|checkbox|dropdown|option|divider)(?!{{IDENTIFIER}})

  CustomComponentName:
    tag: className
    name: entity.name.type.class.view.sd
    match: ({{IDENTIFIER}})

  ViewDeclarationControlKeyword:
    patterns:
      - { include: "#ViewDeclarationControlInnerKeyword" }
      - { include: "#ViewDeclarationControlTopKeyword" }

  ViewDeclarationControlInnerKeyword:
    tag: controlKeyword
    name: keyword.control.inner.view.sd
    match: (case|fill|slot)(?=$|{{WS}})

  ViewDeclarationControlTopKeyword:
    tag: controlKeyword
    name: keyword.control.view.sd
    match: ({{CONDITIONAL_BLOCK_KEYWORDS}})(?=$|{{WS}})

  InKeyword:
    tag: controlKeyword
    name: keyword.control.in.view.sd
    match: \b(in)\b

  ViewDeclarationAsExpression:
    emit: true
    patterns:
      - { include: "#Expression" }

  ViewDeclarationControlExpression:
    emit: true
    patterns:
      - { include: "#Expression" }

  ViewString:
    tag: string
    name: string.unquoted.view.sd
    begin: (?=\S)
    patterns:
      - { include: "#StringEscape" }
      - { include: "#Comment" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#StringCharacter" }
    end: (?=\s)

  InterpolatedString:
    tag: special(string)
    name: string.interpolated.view.sd
    begin: ([{])
    beginCaptures:
      1:
        tag: special(string)
        name: string.interpolated.view.sd
    patterns:
      - { include: "#StringEscape" }
      - { include: "#Comment" }
      - { include: "#StringCharacter" }
    end: ([}])|($)
    endCaptures:
      1:
        tag: special(string)
        name: string.interpolated.view.sd

  ########## Label ##########

  Label:
    match: ([(])({{WS}}*)({{IDENTIFIER}})({{WS}}*)([)])({{WS}}*)
    captures:
      1:
        patterns:
          - { include: "#LabelBeginMark" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#LabelDeclarationName" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
      5:
        patterns:
          - { include: "#LabelEndMark" }
      6:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  LabelBeginMark:
    tag: keyword
    name: keyword.flow.label.sd
    match: (.+)

  LabelEndMark:
    tag: keyword
    name: keyword.flow.label.sd
    match: (.+)

  LabelDeclarationName:
    tag: definition(heading)
    name: keyword.control.section.sd
    match: (.+)

  ########## Break ##########

  Break:
    tag: special(content)
    name: meta.break.sd
    match: ({{BREAK}})
    captures:
      1:
        tag: keyword
        name: keyword.other.break.sd

  ########## Chain ##########

  Chain:
    tag: special(meta)
    name: meta.chain.sd
    match: ({{WS}}*)([\\])(?:({{WS}}+)$|({{WS}}*))
    captures:
      1:
        patterns:
          - { include: "#Whitespace" }
      2:
        tag: keyword
        name: keyword.other.chain.sd
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#Separator" }

  ########## Glue ##########

  Glue:
    tag: meta
    name: meta.glue.sd
    match: ({{WS}}*)([<][>])
    captures:
      1:
        patterns:
          - { include: "#Whitespace" }
      2:
        tag: keyword
        name: keyword.other.glue.sd

  ########## Choice ##########

  Choice:
    name: entity.choice.sd
    begin: ({{WS}}*)((?:[*]{{EOK}})+|(?:[+]{{EOK}})+)([(][^()]*[)]{{WS}}*)?(?:((?:[{][^{}]*[}]{{WS}}*)+))?(\r\n|\r|\n)?
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ChoiceMark" }
      3:
        patterns:
          - { include: "#Label" }
      4:
        patterns:
          - { include: "#ConditionalBracedBlock" }
      5:
        patterns:
          - { include: "#Newline" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#ChoiceConditional" }
      - { include: "#ChoiceWithSuppressedText" }
      - { include: "#ChoiceWithNoSuppressedText" }
    end: (?=$)

  ChoiceConditional:
    name: entity.choice.sd
    match: ^({{WS}}*)((?:[{][^{}]*[}]{{WS}}*)+)(\r\n|\r|\n)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ConditionalBracedBlock" }
      3:
        patterns:
          - { include: "#Newline" }

  ChoiceMark:
    tag: keyword
    name: keyword.operator.expression.list.sd
    match: (.+)

  ChoiceWithSuppressedText:
    match: (.*?)(\[)(.*?)(\])(.*?)(?:({{WS}}*)$|({{WS}}*)([-][>].*$))
    captures:
      1:
        patterns:
          - { include: "#ChoiceTextContent" }
      2:
        tag: keyword
        name: punctuation.definition.template-expression.begin.choice.suppression.sd
      3:
        patterns:
          - { include: "#ChoiceTextContent" }
      4:
        tag: keyword
        name: punctuation.definition.template-expression.end.choice.suppression.sd
      5:
        patterns:
          - { include: "#DisplayText" }
      6:
        patterns:
          - { include: "#ExtraWhitespace" }
      7:
        patterns:
          - { include: "#Separator" }
      8:
        patterns:
          - { include: "#Divert" }

  ChoiceWithNoSuppressedText:
    match: (.+?)(?:({{WS}}*)$|({{WS}}*)([-][>].*$))
    captures:
      1:
        patterns:
          - { include: "#ChoiceTextContent" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#Divert" }

  ChoiceTextContent:
    tag: string
    name: string.choice.sd
    match: (.+)
    captures:
      1:
        patterns:
          - { include: "#Annotation" }
          - { include: "#ConditionalBracedBlock" }
          - { include: "#DisplayText" }

  ########## Logic ##########

  Logic:
    tag: meta
    name: meta.logic.sd
    begin: ({{WS}}*)(~)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#LogicMark" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#ReturnStatement" }
      - { include: "#TempDeclaration" }
      - { include: "#Expression" }
    end: ({{EOL}})(\r\n|\r|\n)?
    endCaptures:
      1:
        patterns:
          - { include: "#EndOfLine" }
      2:
        patterns:
          - { include: "#Newline" }

  LogicMark:
    tag: keyword
    name: keyword.other.logic.sd
    match: (.+)

  ReturnStatement:
    begin: ({{WS}}*)(~{{EOK}})?({{WS}}*)(return)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#OptionalLogicMark" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#ReturnKeyword" }
      5:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Expression" }
    end: (?=$)

  ReturnKeyword:
    tag: controlKeyword
    name: keyword.control.return.sd
    match: (.+)

  TempDeclaration:
    begin: ({{WS}}*)(~{{EOK}})?({{WS}}*)(temp)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#OptionalLogicMark" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#TempKeyword" }
      5:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#VariableAssignment" }
    end: (?=$)

  OptionalLogicMark:
    tag: keyword
    name: keyword.other.logic.optional.sd
    match: (.+)

  TempKeyword:
    tag: controlKeyword
    name: keyword.control.definition.temp.sd
    match: (.+)

  ########## Gather ##########

  Gather:
    match: ^({{WS}}*)((?:[-]{{EOK}})+)({{WS}}*)([(][^()]*[)]{{WS}}*)?
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#GatherMark" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#Label" }

  GatherMark:
    tag: keyword
    name: keyword.other.gather.sd
    match: (.+)

  ########## Scene, Knot, Branch, Stitch, Function ##########

  Scene:
    begin: ^({{WS}}*)(scene)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#SceneKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#SceneWithParametersDeclaration" }
      - { include: "#SceneWithoutParametersDeclaration" }
    end: ([:])|(?=$)
    endCaptures:
      1:
        patterns:
          - { include: "#ColonOperator" }

  SceneWithParametersDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "#SceneDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$|{{COMMENT_START}}|{{WS}}*(?![(]))

  SceneWithoutParametersDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#SceneDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$|{{COMMENT_START}}|{{WS}}*(?![(]))

  SceneKeyword:
    tag: controlKeyword
    name: keyword.control.scene.sd
    match: (.+)

  SceneDeclarationName:
    tag: definition(heading)
    name: keyword.control.section.sd
    match: (.+)

  Knot:
    begin: ^({{WS}}*)([=]{2,}{{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#KnotBeginMark" }
    patterns:
      - { include: "#KnotFunction" }
      - { include: "#KnotWithParametersDeclaration" }
      - { include: "#KnotWithoutParametersDeclaration" }
    end: ({{WS}}*[=]{2,})|(?=$)
    endCaptures:
      1:
        patterns:
          - { include: "#KnotEndMark" }

  KnotWithParametersDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "#KnotDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$|[=]|{{COMMENT_START}}|{{WS}}*(?![(]))

  KnotWithoutParametersDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#KnotDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$|[=]|{{COMMENT_START}}|{{WS}}*(?![(]))

  KnotBeginMark:
    tag: keyword
    name: keyword.flow.knot.sd
    match: (.+)

  KnotEndMark:
    tag: keyword
    name: keyword.flow.knot.sd
    match: (.+)

  KnotDeclarationName:
    tag: definition(heading)
    name: keyword.control.section.sd
    match: (.+)

  Branch:
    begin: ^({{WS}}*)(branch)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#BranchKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#BranchWithParametersDeclaration" }
      - { include: "#BranchWithoutParametersDeclaration" }
    end: ([:])|(?=$)
    endCaptures:
      1:
        patterns:
          - { include: "#ColonOperator" }

  BranchWithParametersDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "#BranchDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$|{{COMMENT_START}}|{{WS}}*(?![(]))

  BranchWithoutParametersDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#BranchDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$|{{COMMENT_START}}|{{WS}}*(?![(]))

  BranchKeyword:
    tag: controlKeyword
    name: keyword.control.branch.sd
    match: (.+)

  BranchDeclarationName:
    tag: definition(heading)
    name: keyword.control.section.sd
    match: (.+)

  Stitch:
    begin: ^({{WS}}*)([=])({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#StitchBeginMark" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#StitchWithParametersDeclaration" }
      - { include: "#StitchWithoutParametersDeclaration" }
    end: ([=]+)|(?=$)
    endCaptures:
      1:
        patterns:
          - { include: "#InvalidValue" }

  StitchWithParametersDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)(?=[(])
    beginCaptures:
      1:
        patterns:
          - { include: "#StitchDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$|[=]|{{COMMENT_START}}|{{WS}}*(?![(]))

  StitchWithoutParametersDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#StitchDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$|[=]|{{COMMENT_START}}|{{WS}}*(?![(]))

  StitchBeginMark:
    tag: keyword
    name: keyword.flow.stitch.sd
    match: (.+)

  StitchEndMark:
    tag: keyword
    name: keyword.flow.stitch.sd
    match: (.+)

  StitchDeclarationName:
    tag: definition(heading)
    name: keyword.control.section.sd
    match: (.+)

  Function:
    begin: ^({{WS}}*)(function)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#FunctionKeyword" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#FunctionDeclaration" }
    end: ([:])|(?=$)
    endCaptures:
      1:
        patterns:
          - { include: "#ColonOperator" }

  KnotFunction:
    begin: (function)({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#FunctionKeyword" }
      2:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#FunctionDeclaration" }
    end: (?=$|{{WS}}*[=]{2,})

  FunctionDeclaration:
    begin: ({{IDENTIFIER}})({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#FunctionDeclarationName" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#FunctionDeclarationParameters" }
    end: (?=$)

  FunctionKeyword:
    tag: controlKeyword
    name: keyword.control.function.sd
    match: (.+)

  FunctionDeclarationName:
    tag: definition(heading)
    name: keyword.control.section.sd
    match: (.+)

  FunctionEndMark:
    tag: keyword
    name: keyword.flow.function.sd
    match: (.+)

  ########## Divert & Thread ##########

  Divert:
    begin: ({{WS}}*)([-][>][-][>]|[-][>])
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#TunnelMark" }
          - { include: "#DivertMark" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Tunnel" }
      - { include: "#DivertTarget" }
      - { include: "#ExtraWhitespace" }
    end: (?=$)

  Tunnel:
    begin: ({{WS}}*)([-][>])
    beginCaptures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        patterns:
          - { include: "#DivertMark" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Tunnel" }
      - { include: "#DivertTarget" }
      - { include: "#ExtraWhitespace" }
    end: (?=$)

  Thread:
    begin: ^({{WS}}*)([<][-])
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ThreadMark" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#DivertTarget" }
      - { include: "#ExtraWhitespace" }
    end: (?=$|[^\s{{IDENTIFIER_END_CHAR}}])

  DivertMark:
    tag: controlKeyword
    name: keyword.control.divert.mark.sd
    match: ([-][>])

  TunnelMark:
    tag: controlKeyword
    name: keyword.control.divert.mark.sd
    match: ([-][>][-][>])

  ThreadMark:
    tag: controlKeyword
    name: keyword.control.thread.mark.sd
    match: ([<][-])

  End:
    tag: keyword
    name: constant.language.end.sd
    match: \b(END)\b

  Done:
    tag: keyword
    name: constant.language.done.sd
    match: \b(DONE)\b

  DivertTarget:
    tag: heading
    name: keyword.control.divert.path.sd
    begin: ({{WS}}*)(?={{IDENTIFIER}}|[.^])
    beginCaptures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#End" }
      - { include: "#Done" }
      - { include: "#FunctionCall" }
      - { include: "#DivertPath" }
    end: (?=$)|(?!{{IDENTIFIER}}|[.^])

  DivertPath:
    tag: heading
    name: keyword.control.divert.path.sd
    begin: (?={{IDENTIFIER}}|[.^])
    patterns:
      - { include: "#Annotation" }
      - { include: "#DivertPart" }
    end: (?=$)|(?!{{IDENTIFIER}}|[.^])

  DivertPart:
    emit: true
    patterns:
      - { include: "#PunctuationAccessor" }
      - { include: "#DivertPartNumber" }
      - { include: "#DivertPartOperator" }
      - { include: "#DivertPartName" }

  DivertPartNumber:
    tag: heading
    name: keyword.control.divert.path.sd
    match: ([0-9]+)

  DivertPartOperator:
    tag: heading
    name: keyword.control.divert.path.sd
    match: ([.^])

  DivertPartName:
    tag: heading
    name: keyword.control.divert.path.sd
    match: ({{IDENTIFIER}})

  ########## ConditionalBracedBlock (anything within {}) ##########

  ConditionalBracedBlock:
    tag: meta
    name: meta.definition.type.conditional-block.sd
    brackets: true
    begin: ([{])({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#ConditionalBlockOpenBrace" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#CloseBraceAhead" }
      - { include: "#MultilineAlternative" }
      - { include: "#MultilineBlock" }
      - { include: "#ConditionalSubstitution" }
      - { include: "#Divert" }
      - { include: "#Substitution" }
      - { include: "#FirstAlternativeItem" }
      - { include: "#AlternativeItem" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#InlineConditionalText" }
    end: ({{WS}}*)([}])({{WS}}*)?
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#ConditionalBlockCloseBrace" }
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  ConditionalBlockOpenBrace:
    tag: keyword
    name: punctuation.definition.template-expression.begin.sd
    match: ([{])

  ConditionalBlockCloseBrace:
    tag: keyword
    name: punctuation.definition.template-expression.end.sd
    match: ([}])

  Substitution:
    name: keyword.control.sd
    match: (?<=[{]{{WS}}*)({{WS}}*)([^{}:|]+)((?<!{{WS}}){{WS}}*)(?=[}])
    captures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#Expression" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }

  FirstAlternativeItem:
    begin: (?<=[{]{{WS}}*)({{WS}}*)([&!~])
    beginCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        tag: controlKeyword
        name: keyword.control.alternative.type.sd
    patterns:
      - { include: "#Annotation" }
      - { include: "#PipeAhead" }
      - { include: "#Literal" }
      - { include: "#Divert" }
      - { include: "#ConditionalSubstitution" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#InlineConditionalText" }
    end: (?=[|])

  AlternativeItem:
    begin: ([|])
    beginCaptures:
      1:
        patterns:
          - { include: "#AlternativeOperator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#CloseBraceAhead" }
      - { include: "#PipeAhead" }
      - { include: "#Literal" }
      - { include: "#Divert" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#InlineConditionalText" }
    end: (?=[}]|[|])

  ConditionalSubstitution:
    begin: ((?:[^:{}|]|[|](?=[|]))+)((?<!{{WS}}){{WS}}*)([:])({{WS}}*)(?!{{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Expression" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#ColonOperator" }
      4:
        patterns:
          - { include: "#Whitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#CloseBraceAhead" }
      - { include: "#Divert" }
      - { include: "#InlineElseClause" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#InlineConditionalText" }
    end: ({{WS}}*)(?=[}])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }

  InlineElseClause:
    begin: ([|])
    beginCaptures:
      1:
        patterns:
          - { include: "#AlternativeOperator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#CloseBraceAhead" }
      - { include: "#Divert" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#InlineConditionalText" }
    end: (?=[}])

  MultilineBlock:
    begin: ([^{}:]+)((?<!{{WS}}){{WS}}*)([:])(?={{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#SequenceKeyword" }
          - { include: "#Expression" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#ColonOperator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#MultilineCloseBraceAhead" }
      - { include: "#MultilineCaseClause" }
      - { include: "#MultilineAlternativeClause" }
      - { include: "#Divert" }
      - { include: "#ReturnStatement" }
      - { include: "#TempDeclaration" }
      - { include: "#Logic" }
      - { include: "#Choice" }
      - { include: "#Todo" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#MultilineConditionalText" }
    end: (?=[}])

  MultilineAlternative:
    begin: (?<=[{]{{WS}}*)({{WS}}*)(?={{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#MultilineCloseBraceAhead" }
      - { include: "#MultilineCaseClause" }
      - { include: "#MultilineAlternativeClause" }
      - { include: "#Divert" }
      - { include: "#Thread" }
      - { include: "#ReturnStatement" }
      - { include: "#TempDeclaration" }
      - { include: "#Logic" }
      - { include: "#Choice" }
      - { include: "#Todo" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#MultilineConditionalText" }
    end: (?=[}])

  MultilineCaseClause:
    begin: ^({{WS}}*)([-])({{EOK}})(?:(else)|([^|{}:]+))({{WS}}*)([:])({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#MultilineCaseMark" }
      3:
        patterns:
          - { include: "#Separator" }
      4:
        patterns:
          - { include: "#ElseKeyword" }
      5:
        patterns:
          - { include: "#Expression" }
      6:
        patterns:
          - { include: "#ExtraWhitespace" }
      7:
        patterns:
          - { include: "#ColonOperator" }
      8:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#MultilineCloseBraceAhead" }
      - { include: "#MultilineDashAhead" }
      - { include: "#Divert" }
      - { include: "#Thread" }
      - { include: "#ReturnStatement" }
      - { include: "#TempDeclaration" }
      - { include: "#Logic" }
      - { include: "#Choice" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#MultilineConditionalText" }
    end: (?=^|[}]|[-]{{EOK}})

  ElseKeyword:
    tag: controlKeyword
    name: keyword.control.else.sd
    match: (.+)

  MultilineAlternativeClause:
    begin: ^({{WS}}*)([-])({{EOK}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#MultilineAlternativeMark" }
      3:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#MultilineCloseBraceAhead" }
      - { include: "#MultilineDashAhead" }
      - { include: "#Divert" }
      - { include: "#Thread" }
      - { include: "#ReturnStatement" }
      - { include: "#TempDeclaration" }
      - { include: "#Logic" }
      - { include: "#Choice" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#MultilineConditionalText" }
    end: (?=^|[}]|[-]{{EOK}})

  SequenceKeyword:
    tag: controlKeyword
    name: keyword.control.sequence.sd
    match: \b(stopping|shuffle|cycle|once)\b

  InlineConditionalText:
    patterns:
      - { include: "#DisplayText" }

  MultilineConditionalText:
    begin: (?={{WS}}*\S)
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#MultilineCloseBraceAhead" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#ConditionalIndentedBlock" }
      - { include: "#Title" }
      - { include: "#Heading" }
      - { include: "#Transitional" }
      - { include: "#Write" }
      - { include: "#Dialogue" }
      - { include: "#Action" }
      - { include: "#DisplayText" }
    end: (?=$|{{WS}}*[}])

  MultilineCaseMark:
    tag: keyword
    name: keyword.switch.clause.sd
    match: ([-])

  MultilineAlternativeMark:
    tag: keyword
    name: keyword.sequence.clause.sd
    match: ([-])

  PipeAhead:
    match: (?=[|])

  CloseBraceAhead:
    match: (?=[}])

  MultilineCloseBraceAhead:
    match: ^({{WS}}*)(?=[}])
    captures:
      1:
        patterns:
          - { include: "#Indent" }

  MultilineDashAhead:
    match: ^({{WS}}*)(?=[-]{{EOK}})
    captures:
      1:
        patterns:
          - { include: "#Indent" }

  ########## ConditionalIndentedBlock ##########

  ConditionalIndentedBlock:
    tag: meta
    name: meta.definition.type.conditional-block.sd
    brackets: true
    begin: ({{WS}}*)({{CONDITIONAL_BLOCK_KEYWORDS}})\b
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ConditionalKeyword" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Expression" }
    end: ([:])|(?=$)
    endCaptures:
      1:
        patterns:
          - { include: "#ColonOperator" }

  ########## Expression ##########

  Expression:
    patterns:
      - { include: "#Comment" }
      - { include: "#ConditionalKeyword" }
      - { include: "#RefModifier" }
      - { include: "#FunctionCall" }
      - { include: "#Divert" }
      - { include: "#Operator" }
      - { include: "#Literal" }
      - { include: "#Separator" }
      - { include: "#Newline" }
      - { include: "#ParenExpression" }
      - { include: "#BracketExpression" }
      - { include: "#BraceExpression" }
      - { include: "#AccessPath" }
      - { include: "#PunctuationComma" }
      - { include: "#IllegalChar" }

  ConditionalKeyword:
    tag: controlKeyword
    name: keyword.control.definition.const.sd
    match: ({{CONDITIONAL_BLOCK_KEYWORDS}})\b

  ParentheticalExpression:
    brackets: true
    begin: ([(])({{WS}}*)
    beginCaptures:
      1:
        tag: keyword
        name: punctuation.definition.template-expression.begin.sd
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Separator" }
      - { include: "#InKeyword" }
      - { include: "#Expression" }
    end: $|({{WS}}*)([)])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        tag: keyword
        name: punctuation.definition.template-expression.end.sd

  Indent:
    tag: content
    name: markup.raw.whitespace.indent.sd
    match: ^({{WS}}+)

  TrailingWhitespace:
    tag: special(content)
    name: markup.raw.whitespace.trailing.sd
    match: (?<!^)({{WS}}+)$

  ExtraWhitespace:
    tag: content
    name: markup.raw.whitespace.extra.sd
    match: ({{WS}}+)

  Whitespace:
    tag: content
    name: markup.raw.whitespace.sd
    match: ({{WS}}+)

  Separator:
    tag: definition(content)
    name: markup.raw.whitespace.separator.sd
    match: ({{WS}}+)

  OptionalSeparator:
    tag: definition(content)
    name: markup.raw.whitespace.separator.optional.sd
    match: ({{WS}}*)

  EndOfLine:
    patterns:
      - { include: "#Annotation" }
      - { include: "#TrailingWhitespace" }

  Operator:
    patterns:
      - { include: "#HasOperator" }
      - { include: "#SpreadOperator" }
      - { include: "#AssignArithmeticOperator" }
      - { include: "#AssignBitwiseOperator" }
      - { include: "#BitwiseShiftOperator" }
      - { include: "#CompareEqualOperator" }
      - { include: "#CompareRelativeOperator" }
      - { include: "#HasntOperator" }
      - { include: "#NegateOperator" }
      - { include: "#LogicalOperator" }
      - { include: "#WordOperator" }
      - { include: "#BitwiseOperator" }
      - { include: "#AssignEqualOperator" }
      - { include: "#DecrementOperator" }
      - { include: "#IncrementOperator" }
      - { include: "#ArithmeticOperator" }
      - { include: "#AssignMultiplyOperator" }
      - { include: "#AssignDivideOperator" }

  SpreadOperator:
    tag: derefOperator
    name: keyword.operator.spread.sd
    match: ([.][.][.])

  AssignArithmeticOperator:
    match: ({{WS}}*)([*][=]|(?<!\()[/][=]|[%][=]|[+][=]|[-][=])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: updateOperator
        name: keyword.operator.assignment.compound.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  AssignBitwiseOperator:
    match: ({{WS}}*)([&][=]|[\^][=]|[<][<][=]|[>][>][=]|[>][>][>][=]|[|][=])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: updateOperator
        name: keyword.operator.assignment.compound.bitwise.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  BitwiseShiftOperator:
    match: ({{WS}}*)([<][<]|[>][>][>]|[>][>])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: updateOperator
        name: keyword.operator.bitwise.shift.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  CompareEqualOperator:
    match: ({{WS}}*)([=][=][=]|[!][=][=]|[=][=]|[!][=])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: compareOperator
        name: keyword.operator.comparison.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  CompareRelativeOperator:
    match: ({{WS}}*)([<][=]|[>][=]|[<][>]|[<]|[>])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: compareOperator
        name: keyword.operator.relational.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  HasntOperator:
    match: ({{WS}}*)([!][?])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: logicOperator
        name: keyword.operator.logical.hasnt.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  HasOperator:
    match: ({{WS}}*)([?])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: logicOperator
        name: keyword.operator.logical.has.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  NegateOperator:
    match: ({{WS}}*)([!])
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: logicOperator
        name: keyword.operator.logical.sd

  LogicalOperator:
    match: ({{WS}}*)([&][&]|[|][|]|[?][?])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: logicOperator
        name: keyword.operator.logical.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  BitwiseOperator:
    match: ({{WS}}*)([&]|[~]|[\^]|[|])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: bitwiseOperator
        name: keyword.operator.bitwise.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  AssignEqualOperator:
    match: ({{WS}}*)([=])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: updateOperator
        name: keyword.operator.assignment.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  DecrementOperator:
    match: ([-][-])({{WS}}*)
    captures:
      1:
        tag: updateOperator
        name: keyword.operator.decrement.sd
      2:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  IncrementOperator:
    match: ([+][+])({{WS}}*)
    captures:
      1:
        tag: updateOperator
        name: keyword.operator.increment.sd
      2:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  ArithmeticOperator:
    match: ({{WS}}*)([%]|[*]|[/]|[-]|[+])({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: arithmeticOperator
        name: keyword.operator.arithmetic.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  AssignMultiplyOperator:
    begin: (?<=[)\]{{IDENTIFIER_END_CHAR}}])({{WS}}*)(?=(\/[*]([^*]|([*][^\/]))*[*]\/\s*)+(?:(/=)|(?:(/)(?![/*]))))
    beginCaptures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
    patterns:
      - { include: "#Comment" }
    end: (?:(/=)|(?:(/)(?![*]([^*]|([*][^\/]))*[*][/])))({{WS}}*)
    endCaptures:
      1:
        tag: updateOperator
        name: keyword.operator.assignment.compound.sd
      2:
        tag: arithmeticOperator
        name: keyword.operator.arithmetic.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  AssignDivideOperator:
    match: (?<=[)\]{{IDENTIFIER_END_CHAR}}])({{WS}}*)([/][=]|([/])(?![/*]))({{WS}}*)
    captures:
      1:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      2:
        tag: arithmeticOperator
        name: keyword.operator.arithmetic.sd
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  AlternativeOperator:
    tag: logicOperator
    name: meta.template.expression.operator.pipe.sd
    match: ([|])

  ColonOperator:
    tag: logicOperator
    name: meta.template.expression.operator.colon.sd
    match: ([:])

  ColonSeparator:
    tag: definition(logicOperator)
    name: meta.template.expression.operator.colon.sd
    match: ([:])

  WordOperator:
    match: \b(not|and|or|has|hasnt|mod)\b({{WS}}*)
    captures:
      1:
        tag: keyword
        name: keyword.logical.word.sd
      2:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  Literal:
    patterns:
      - { include: "#StringLiteral" }
      - { include: "#NumericLiteral" }
      - { include: "#BooleanLiteral" }
      - { include: "#NullLiteral" }
      - { include: "#UndefinedLiteral" }

  StringLiteral:
    tag: string
    name: string.quoted.double.sd
    begin: (["])
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationStringOpen" }
    patterns:
      - { include: "#Comment" }
      - { include: "#StringContent" }
    end: (["])|($)
    endCaptures:
      1:
        patterns:
          - { include: "#PunctuationStringClose" }

  StringContent:
    patterns:
      - { include: "#StringEscape" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#StringCharacter" }

  PunctuationStringOpen:
    match: (["])
    tag: string
    name: punctuation.definition.string.begin.sd

  PunctuationStringClose:
    match: (["])
    tag: string
    name: punctuation.definition.string.end.sd

  StringEscape:
    match: (\\)(.)
    captures:
      1:
        tag: definition(escape)
        name: constant.character.escape.sd
      2:
        tag: content
        name: markup.raw.whitespace.sd

  StringCharacter:
    tag: content
    name: markup.raw.whitespace.sd
    match: (.)

  NumericLiteral:
    patterns:
      - { include: "#NumberLiteral" }
      - { include: "#NumericConstantLiteral" }

  NumberLiteral:
    tag: number
    name: constant.numeric.sd
    match: ([-]?(?:\d*[.])?\d+)

  NumericConstantLiteral:
    patterns:
      - { include: "#Infinity" }
      - { include: "#NaN" }

  NaN:
    tag: atom
    name: constant.language.nan.sd
    match: "{{BEFORE_KEYWORD}}NaN{{AFTER_KEYWORD}}"

  Infinity:
    tag: atom
    name: constant.language.infinity.sd
    match: "{{BEFORE_KEYWORD}}Infinity{{AFTER_KEYWORD}}"

  BooleanLiteral:
    patterns:
      - { include: "#BooleanTrue" }
      - { include: "#BooleanFalse" }

  BooleanTrue:
    tag: bool
    name: constant.language.boolean.true.sd
    match: "{{BEFORE_KEYWORD}}true{{AFTER_KEYWORD}}"

  BooleanFalse:
    tag: bool
    name: constant.language.boolean.false.sd
    match: "{{BEFORE_KEYWORD}}false{{AFTER_KEYWORD}}"

  NullLiteral:
    tag: "null"
    name: constant.language.null.sd
    match: "{{BEFORE_KEYWORD}}null{{AFTER_KEYWORD}}"

  UndefinedLiteral:
    tag: "null"
    name: constant.language.undefined.sd
    match: "{{BEFORE_KEYWORD}}undefined{{AFTER_KEYWORD}}"

  ArrayLiteral:
    name: meta.array.literal.sd
    brackets: true
    begin: (\[)
    beginCaptures:
      1:
        tag: brace
        name: meta.brace.square.open.sd
    patterns:
      - { include: "#Comment" }
      - { include: "#ArrayItem" }
      - { include: "#Newline" }
    end: (\])
    endCaptures:
      1:
        tag: brace
        name: meta.brace.square.close.sd

  ArrayItem:
    tag: meta
    name: meta.item.sd
    begin: (?=.+$)
    patterns:
      - { include: "#Comment" }
      - { include: "#Expression" }
    end: (?=\])|([,])
    endCaptures:
      1:
        tag: separator
        name: meta.template.expression.comma.sd

  PunctuationComma:
    tag: operator
    name: keyword.operator.comma.sd
    match: ([,])

  PunctuationSemicolon:
    tag: separator
    name: meta.template.expression.semicolon.sd
    match: ([;])

  PunctuationParenOpen:
    match: ([(])
    tag: keyword
    name: punctuation.definition.template-expression.begin.sd

  PunctuationParenClose:
    match: ([)])
    tag: keyword
    name: punctuation.definition.template-expression.end.sd

  PunctuationBracketOpen:
    match: (\[)
    tag: keyword
    name: punctuation.definition.template-expression.begin.sd

  PunctuationBracketClose:
    match: (\])
    tag: keyword
    name: punctuation.definition.template-expression.end.sd

  PunctuationBraceOpen:
    match: (\{)
    tag: keyword
    name: punctuation.definition.template-expression.begin.sd

  PunctuationBraceClose:
    match: (\})
    tag: keyword
    name: punctuation.definition.template-expression.end.sd

  ParenExpression:
    brackets: true
    begin: ([(])({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationParenOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Expression" }
    end: $|({{WS}}*)([)])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#PunctuationParenClose" }

  BracketExpression:
    brackets: true
    begin: (\[)({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationBracketOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Expression" }
    end: $|({{WS}}*)(\])
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#PunctuationBracketClose" }

  BraceExpression:
    brackets: true
    begin: (\{)({{WS}}*)
    beginCaptures:
      1:
        patterns:
          - { include: "#PunctuationBraceOpen" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#Expression" }
    end: $|({{WS}}*)(\})
    endCaptures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#PunctuationBraceClose" }

  NamespaceAccessor:
    match: ({{IDENTIFIER}})([.])($|{{IDENTIFIER}})(?![(])
    captures:
      1:
        patterns:
          - { include: "#TypeName" }
      2:
        patterns:
          - { include: "#PunctuationAccessor" }
      3:
        patterns:
          - { include: "#VariableName" }

  VariableAccessor:
    match: ([.])({{IDENTIFIER}})(?![(])
    captures:
      1:
        patterns:
          - { include: "#PunctuationAccessor" }
      2:
        patterns:
          - { include: "#VariableName" }

  PropertyAccessor:
    match: ([.])({{IDENTIFIER}})(?![(])
    captures:
      1:
        patterns:
          - { include: "#PunctuationAccessor" }
      2:
        patterns:
          - { include: "#PropertyName" }

  IllegalPropertyDeclaration:
    tag: invalid
    name: invalid.illegal.property-declaration.sd
    match: ({{IDENTIFIER}})({{WS}}*)([:])(.*?)($|(?=[;}]))

  TypeName:
    tag: typeName
    name: support.type.sd
    match: ({{IDENTIFIER}})

  VariableName:
    tag: variableName
    name: variable.other.constant.sd
    match: ({{IDENTIFIER}})(?![(])

  PropertyName:
    tag: propertyName
    name: variable.other.property.sd
    match: ({{IDENTIFIER}})(?![(])

  FunctionName:
    tag: heading
    name: keyword.control.divert.path.sd
    match: ({{IDENTIFIER}})

  Identifier:
    match: ({{IDENTIFIER}})

  PunctuationAccessor:
    match: ([.])
    tag: separator
    name: meta.template.expression.accessor.sd

  Color:
    emit: true
    patterns:
      - { include: "#HEXColor" }
      - { include: "#RGBColor" }
      - { include: "#HSLColor" }

  HEXColor:
    tag: string
    name: string.color.hex.sd
    match: (#)([0-9a-fA-F]{3,})
    color: true

  RGBColor:
    tag: string
    name: string.color.rgb.sd
    match: (rgb)([(][\d]+[\s]+[\d]+[\s]+[\d]+(?:[\s]*[/][\s]*[\d.]+[%]?)?[)])
    color: true

  HSLColor:
    tag: string
    name: string.color.hsl.sd
    match: (hsl)([(][\d]+[\s]+[\d]+[%]?[\s]+[\d]+[%]?(?:[\s]*[/][\s]*[\d.]+[%]?)?[)])
    color: true

  ########## FrontMatter ##########

  FrontMatter:
    tag: meta
    name: meta.front-matter.sd
    begin: ^([-]{3,})($|{{WS}}*$)
    beginCaptures:
      1:
        tag: keyword
        name: keyword.other.front-matter.dashes.start.sd
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Comment" }
      - { include: "#FrontMatterField" }
      - { include: "#Newline" }
      - { include: "#Unknown" }
    end: ^([-]{3,})($|{{WS}}*$)?
    endCaptures:
      1:
        tag: keyword
        name: keyword.other.front-matter.dashes.end.sd
      2:
        patterns:
          - { include: "#ExtraWhitespace" }

  FrontMatterField:
    tag: meta
    name: meta.front-matter.field.sd
    begin: ^(?!{{WS}}+)([^{}:\r\n]+)({{WS}}*)($|[:])($|.*$(?:\r\n|\r|\n)?)
    beginCaptures:
      1:
        patterns:
          - { include: "#FrontMatterFieldKeyword" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#ColonOperator" }
      4:
        patterns:
          - { include: "#FrontMatterStringInline" }
    patterns:
      - { include: "#Comment" }
      - { include: "#FrontMatterStringBlock" }
      - { include: "#Newline" }
      - { include: "#Unknown" }
    end: (?=^(?!{{WS}}+)[^{}:\r\n]+{{WS}}*(?:$|[:])|[-]{3,})

  FrontMatterFieldKeyword:
    tag: keyword
    name: keyword.other.front-matter.field.sd
    match: (.+)

  FrontMatterStringInline:
    match: ({{WS}}*)($|.+$(?:\r\n|\r|\n)?)
    captures:
      1:
        patterns:
          - { include: "#Separator" }
      2:
        patterns:
          - { include: "#FrontMatterString" }

  FrontMatterStringBlock:
    match: ^({{WS}}+)(.*$(?:\r\n|\r|\n)?)
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#FrontMatterString" }

  FrontMatterString:
    tag: string
    name: string.front-matter.string.sd
    begin: (?=.*$)
    patterns:
      - { include: "#Comment" }
      - { include: "#InlineText" }
    end: ($(?:\r\n|\r|\n)?)
    endCaptures:
      1:
        patterns:
          - { include: "#Newline" }

  ########## Title ##########

  Title:
    patterns:
      - { include: "#BlockTitle" }
      - { include: "#InlineTitle" }

  BlockTitle:
    tag: monospace
    name: constant.character.escape.title.sd
    begin: ^({{WS}}*)(\^)([:])({{WS}}*)(?={{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#TitleMark" }
      3:
        patterns:
          - { include: "#ColonSeparator" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#BlockLineBlank" }
      - { include: "#BlockLineBreak" }
      - { include: "#BlockLineContinue" }
    end: (?=^(?!$|//|\1{{WS}}))

  InlineTitle:
    tag: monospace
    name: constant.character.escape.title.sd
    begin: ({{WS}}*)(\^)([:])($|{{WS}}+)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#TitleMark" }
      3:
        patterns:
          - { include: "#ColonOperator" }
      4:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#LineBreak" }
      - { include: "#LineChain" }
      - { include: "#AssetLine" }
      - { include: "#ParentheticalLine" }
      - { include: "#LineEnd" }
      - { include: "#ExtraWhitespace" }
    end: (?=^{{WS}}*$)|(?=\r\n|\r|\n)|(?=[#])

  TitleMark:
    tag: definition(punctuation)
    name: punctuation.title.mark.sd
    match: (.+)

  ########## Heading ##########

  Heading:
    patterns:
      - { include: "#BlockHeading" }
      - { include: "#InlineHeading" }

  BlockHeading:
    tag: regexp
    name: string.regexp.heading.block.sd
    begin: ^({{WS}}*)([$])([:])({{WS}}*)(?={{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#HeadingMark" }
      3:
        patterns:
          - { include: "#ColonSeparator" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#BlockLineBlank" }
      - { include: "#BlockLineBreak" }
      - { include: "#BlockLineContinue" }
    end: (?=^(?!$|//|\1{{WS}}))

  InlineHeading:
    tag: regexp
    name: string.regexp.heading.inline.sd
    begin: ({{WS}}*)([$])([:])($|{{WS}}+)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#HeadingMark" }
      3:
        patterns:
          - { include: "#ColonOperator" }
      4:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#LineBreak" }
      - { include: "#LineChain" }
      - { include: "#AssetLine" }
      - { include: "#ParentheticalLine" }
      - { include: "#LineEnd" }
      - { include: "#ExtraWhitespace" }
    end: (?=^{{WS}}*$)|(?=\r\n|\r|\n)|(?=[#])

  HeadingMark:
    tag: definition(punctuation)
    name: punctuation.heading.mark.sd
    match: (.+)

  HeadingLocationTime:
    match: INT[.]?[\/]EXT[.]|INT[.]|EXT[.]{{WS}}*(.*?){{WS}}+[-]{{WS}}+(.*?){{WS}}*$

  ########## Transitional ##########

  Transitional:
    patterns:
      - { include: "#BlockTransitional" }
      - { include: "#InlineTransitional" }

  BlockTransitional:
    tag: labelName
    name: keyword.control.transitional.block.sd
    begin: ^({{WS}}*)([%])([:])({{WS}}*)(?={{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#TransitionalMark" }
      3:
        patterns:
          - { include: "#ColonSeparator" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#BlockLineBlank" }
      - { include: "#BlockLineBreak" }
      - { include: "#BlockLineContinue" }
    end: (?=^(?!$|//|\1{{WS}}))

  InlineTransitional:
    tag: labelName
    name: keyword.control.transitional.inline.sd
    begin: ({{WS}}*)([%])([:])($|{{WS}}+)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#TransitionalMark" }
      3:
        patterns:
          - { include: "#ColonOperator" }
      4:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#LineBreak" }
      - { include: "#LineChain" }
      - { include: "#AssetLine" }
      - { include: "#ParentheticalLine" }
      - { include: "#LineEnd" }
      - { include: "#ExtraWhitespace" }
    end: (?=^{{WS}}*$)|(?=\r\n|\r|\n)|(?=[#])

  TransitionalMark:
    tag: definition(punctuation)
    name: punctuation.transitional.mark.sd
    match: (.+)

  ########## Write ##########

  Write:
    patterns:
      - { include: "#BlockWrite" }
      - { include: "#InlineWrite" }

  BlockWrite:
    tag: string
    name: string.write.block.sd
    begin: ^({{WS}}*)([@])({{WS}}*)((?:\\.|[^:\r\n])*)((?<!\\)[:])({{WS}}*)(?={{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#WriteMark" }
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      4:
        patterns:
          - { include: "#WriteTarget" }
      5:
        patterns:
          - { include: "#ColonSeparator" }
      6:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#BlockLineBlank" }
      - { include: "#BlockLineBreak" }
      - { include: "#BlockLineContinue" }
    end: (?=^(?!$|//|\1{{WS}}))

  InlineWrite:
    tag: string
    name: string.write.inline.sd
    begin: ({{WS}}*)([@])({{WS}}*)((?:\\.|[^:\r\n])*)((?<!\\)[:])($|{{WS}}+)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#WriteMark" }
      3:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }
      4:
        patterns:
          - { include: "#WriteTarget" }
      5:
        patterns:
          - { include: "#ColonSeparator" }
      6:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#LineBreak" }
      - { include: "#LineChain" }
      - { include: "#AssetLine" }
      - { include: "#ParentheticalLine" }
      - { include: "#LineEnd" }
    end: (?=^{{WS}}*$)|(?=\r\n|\r|\n)

  WriteMark:
    tag: keyword
    name: keyword.action.mark.sd
    match: (.+)

  WriteTarget:
    tag: propertyName
    name: variable.other.property.write.target.sd
    match: (.+)

  ########## Dialogue ##########

  Dialogue:
    patterns:
      - { include: "#BlockDialogue" }
      - { include: "#InlineDialogue" }

  BlockDialogue:
    tag: string
    name: string.dialogue.block.sd
    begin: ^({{WS}}*)((?=\S)(?:\\.|[^{}:\r\n])+)((?<!\\)[:])({{WS}}*)(?={{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#Annotation" }
          - { include: "#DialogueCharacter" }
      3:
        patterns:
          - { include: "#ColonSeparator" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#BlockLineBlank" }
      - { include: "#BlockLineBreak" }
      - { include: "#BlockLineContinue" }
    end: (?=^(?!$|//|\1{{WS}}))

  InlineDialogue:
    tag: string
    name: string.dialogue.inline.sd
    begin: ({{WS}}*)((?=\S)(?:\\.|[^{}:\r\n])+)((?<!\\)[:])($|{{WS}}+)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#Annotation" }
          - { include: "#DialogueCharacter" }
      3:
        patterns:
          - { include: "#ColonSeparator" }
      4:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#LineBreak" }
      - { include: "#LineChain" }
      - { include: "#AssetLine" }
      - { include: "#ParentheticalLine" }
      - { include: "#LineEnd" }
    end: (?=^{{WS}}*$)|(?=\r\n|\r|\n)

  DialogueMark:
    tag: definition(typeName)
    name: entity.name.type.dialogue.character.name.sd
    match: (.+)

  DialogueCharacter:
    match: ({{WS}}*)(.*?)({{WS}}*)({{WS}}[(][^()]*?[)])?($|{{WS}}*)({{WS}}\[.*?\])?({{EOL}})
    captures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#DialogueCharacterName" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#DialogueCharacterParenthetical" }
      5:
        patterns:
          - { include: "#ExtraWhitespace" }
      6:
        patterns:
          - { include: "#DialogueCharacterPosition" }
      7:
        patterns:
          - { include: "#EndOfLine" }

  DialogueCharacterName:
    tag: typeName
    name: entity.name.type.dialogue.character.name.sd
    match: (.+$)
    captures:
      1:
        patterns:
          - { include: "#DisplayText" }

  DialogueCharacterParenthetical:
    tag: escape
    name: constant.character.escape.dialogue.character.parenthetical.sd
    match: ({{WS}})([(])({{WS}}*)([^()]*?)({{WS}}*)([)])({{WS}}*)
    captures:
      1:
        patterns:
          - { include: "#Whitespace" }
      2:
        tag: paren
        name: meta.brace.round.open.sd
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#DisplayText" }
      5:
        patterns:
          - { include: "#ExtraWhitespace" }
      6:
        tag: paren
        name: meta.brace.round.close.sd
      7:
        patterns:
          - { include: "#ExtraWhitespace" }

  DialogueCharacterPosition:
    tag: definition(escape)
    name: constant.character.escape.dialogue.character.position.sd
    match: ({{WS}})(\[)({{WS}}*)(.*?)({{WS}}*)(\])
    captures:
      1:
        patterns:
          - { include: "#Whitespace" }
      2:
        tag: bracket
        name: punctuation.definition.position.sd
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#DialogueCharacterPositionContent" }
      5:
        patterns:
          - { include: "#ExtraWhitespace" }
      6:
        tag: bracket
        name: punctuation.definition.position.sd

  DialogueCharacterPositionContent:
    match: (.+$)

  ########## Action ##########

  Action:
    patterns:
      - { include: "#BlockAction" }
      - { include: "#InlineAction" }
      - { include: "#ImplicitAction" }

  BlockAction:
    begin: ^({{WS}}*)([:])({{WS}}*)(?={{EOL}})
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ColonSeparator" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#BlockLineBlank" }
      - { include: "#BlockLineBreak" }
      - { include: "#BlockLineContinue" }
    end: (?=^(?!$|//|\1{{WS}}))

  InlineAction:
    begin: ({{WS}}*)(?:([<][>])|([:])($|{{WS}}+))
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#Glue" }
      3:
        patterns:
          - { include: "#ColonOperator" }
      4:
        patterns:
          - { include: "#Separator" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#LineBreak" }
      - { include: "#LineChain" }
      - { include: "#AssetLine" }
      - { include: "#ParentheticalLine" }
      - { include: "#LineEnd" }
      - { include: "#ExtraWhitespace" }
    end: (?=^{{WS}}*$)|(?=\r\n|\r|\n)|(?=[#])

  ImplicitAction:
    begin: ({{WS}}*)(?=\S)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
    patterns:
      - { include: "#Annotation" }
      - { include: "#Newline" }
      - { include: "#LineBreak" }
      - { include: "#LineChain" }
      - { include: "#AssetLine" }
      - { include: "#ParentheticalLine" }
      - { include: "#LineEnd" }
      - { include: "#ExtraWhitespace" }
    end: (?=^{{WS}}*$)|(?=\r\n|\r|\n)|(?=[#])

  ########## Parenthetical ##########

  ParentheticalLine:
    match: ({{WS}}*)((?:[=].*?[=]|[<].*?[>]|{{WS}}*)*)({{WS}}*)([(][^()]*?[)])({{WS}}*)((?:[=].*?[=]|[<].*?[>]|{{WS}}*)*)($|{{EOL}}|(?={{BREAK}})|[\\](?:{{WS}}))
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#TextCommand" }
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#ParentheticalLineContent" }
      5:
        patterns:
          - { include: "#ExtraWhitespace" }
      6:
        patterns:
          - { include: "#TextCommand" }
          - { include: "#ExtraWhitespace" }
      7:
        patterns:
          - { include: "#EndOfLine" }
          - { include: "#Chain" }

  ParentheticalLineContent:
    tag: escape
    name: constant.character.escape.sd
    match: ({{WS}}*)([(])({{WS}}*)([^()]*?)({{WS}}*)([)])({{WS}}*)
    captures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        tag: paren
        name: meta.brace.round.open.sd
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#DisplayText" }
      5:
        patterns:
          - { include: "#ExtraWhitespace" }
      6:
        tag: paren
        name: meta.brace.round.close.sd
      7:
        patterns:
          - { include: "#ExtraWhitespace" }

  ########## Text ##########

  BlockLineBreak:
    match: ({{WS}}*)(.*?)({{BREAK}})({{EOL}})
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#AssetLine" }
          - { include: "#ParentheticalLine" }
          - { include: "#DisplayLine" }
      3:
        patterns:
          - { include: "#Break" }
      4:
        patterns:
          - { include: "#EndOfLine" }

  BlockLineContinue:
    begin: ({{WS}}*)(?=\S)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
    patterns:
      - { include: "#AssetLine" }
      - { include: "#ParentheticalLine" }
      - { include: "#DisplayLine" }
    end: ({{WS}}*)(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#Whitespace" }

  BlockLineBlank:
    match: ^({{WS}}+$)
    captures:
      1:
        patterns:
          - { include: "#Indent" }

  LineChain:
    match: ({{WS}}*)(.*?)([\\](?:$|{{WS}}+))({{EOL}})(\r\n|\r|\n)?
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#DisplayLine" }
      3:
        patterns:
          - { include: "#Chain" }
      4:
        patterns:
          - { include: "#EndOfLine" }
      5:
        patterns:
          - { include: "#Newline" }

  LineBreak:
    match: ({{WS}}*)(.*?)({{BREAK}})({{EOL}})
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#DisplayLine" }
      3:
        patterns:
          - { include: "#Break" }
      4:
        patterns:
          - { include: "#EndOfLine" }

  LineEnd:
    begin: ({{WS}}*)(?=\S)
    beginCaptures:
      1:
        patterns:
          - { include: "#Indent" }
    patterns:
      - { include: "#DisplayLine" }
    end: (?={{EOL}})

  DisplayLine:
    patterns:
      - { include: "#Annotation" }
      - { include: "#Escape" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#ParentheticalLine" }
      - { include: "#Chain" }
      - { include: "#Glue" }
      - { include: "#TextChunk" }

  TextChunk:
    begin: (?=.+)
    patterns:
      - { include: "#DisplayText" }
    end: (?=$|{{WS}}*[\\](?:$|{{WS}})|[<][>]|{{EOL}})

  DisplayText:
    patterns:
      - { include: "#Annotation" }
      - { include: "#Escape" }
      - { include: "#ImageCommand" }
      - { include: "#AudioCommand" }
      - { include: "#InlineTextAndLogic" }

  ########## Commands ##########

  ImageLine:
    match: ^({{WS}}*)(?=\S)((?:\[\[(?:\\.|[^\]])*?\]\]|{{WS}}+)+)({{EOL}})
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ImageCommand" }
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#EndOfLine" }

  AudioLine:
    match: ^({{WS}}*)(?=\S)((?:[(][(](?:\\.|[^)])*?[)][)]|{{WS}}+)+)({{EOL}})
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#AudioCommand" }
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#EndOfLine" }

  ImageAndAudioLine:
    match: ^({{WS}}*)(?=\S)((?:\[\[(?:\\.|[^\]])*?\]\]|[(][(](?:\\.|[^)])*?[)][)]|{{WS}}+)+)({{EOL}})
    captures:
      1:
        patterns:
          - { include: "#Indent" }
      2:
        patterns:
          - { include: "#ImageCommand" }
          - { include: "#AudioCommand" }
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#EndOfLine" }

  AssetLine:
    patterns:
      - { include: "#ImageLine" }
      - { include: "#AudioLine" }
      - { include: "#ImageAndAudioLine" }

  ImageCommand:
    tag: macroName
    name: meta.image.sd
    match: (\[\[)({{WS}}*)((?:\\.|[^\]])*?)({{WS}}*)(\]\])({{WS}}*)
    captures:
      1:
        patterns:
          - { include: "#ImageBeginMark" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#AssetCommandContent" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
      5:
        patterns:
          - { include: "#ImageEndMark" }
      6:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  AudioCommand:
    tag: macroName
    name: meta.audio.sd
    match: ([(][(])({{WS}}*)((?:\\.|[^)])*?)({{WS}}*)([)][)])({{WS}}*)
    captures:
      1:
        patterns:
          - { include: "#AudioBeginMark" }
      2:
        patterns:
          - { include: "#ExtraWhitespace" }
      3:
        patterns:
          - { include: "#AssetCommandContent" }
      4:
        patterns:
          - { include: "#ExtraWhitespace" }
      5:
        patterns:
          - { include: "#AudioEndMark" }
      6:
        emit: true
        patterns:
          - { include: "#OptionalSeparator" }

  AssetCommandContent:
    match: (.*?)($|(?:{{IMAGE_CLAUSE_KEYWORDS}}|{{AUDIO_CLAUSE_KEYWORDS}})(?=$|{{WS}}).*)
    captures:
      1:
        patterns:
          - { include: "#Separator" }
          - { include: "#AssetCommandInstruction" }
      2:
        patterns:
          - { include: "#Annotation" }
          - { include: "#Separator" }
          - { include: "#AssetCommandClauseKeyword" }
          - { include: "#TimeValue" }
          - { include: "#NumberValue" }
          - { include: "#NameValue" }

  AssetCommandInstruction:
    match: (?:({{IMAGE_CONTROL_KEYWORDS}}|{{AUDIO_CONTROL_KEYWORDS}})({{WS}}*)($|\S+))?({{WS}}*)($|\S+)?({{WS}}*)(.*)
    captures:
      1:
        patterns:
          - { include: "#AssetCommandControl" }
      2:
        patterns:
          - { include: "#Separator" }
      3:
        patterns:
          - { include: "#AssetCommandTarget" }
      4:
        patterns:
          - { include: "#Separator" }
      5:
        patterns:
          - { include: "#AssetCommandAddOperator" }
          - { include: "#AssetCommandName" }
          - { include: "#IllegalChar" }
      6:
        patterns:
          - { include: "#Separator" }
      7:
        patterns:
          - { include: "#AssetCommandAddOperator" }
          - { include: "#AssetCommandName" }
          - { include: "#IllegalChar" }

  ImageBeginMark:
    tag: keyword
    name: keyword.operator.expression.begin.image.sd
    match: (.+)

  ImageEndMark:
    tag: keyword
    name: keyword.operator.expression.end.image.sd
    match: (.+)

  AudioBeginMark:
    tag: keyword
    name: keyword.operator.expression.begin.audio.sd
    match: (.+)

  AudioEndMark:
    tag: keyword
    name: keyword.operator.expression.end.audio.sd
    match: (.+)

  AssetCommandControl:
    tag: controlKeyword
    name: keyword.control.asset.control.sd
    match: (.+)

  AssetCommandTarget:
    tag: typeName
    name: entity.name.type.asset.target.sd
    match: (.+)

  AssetCommandClauseKeyword:
    tag: keyword
    name: keyword.asset.clause.keyword.sd
    match: ({{IMAGE_CLAUSE_KEYWORDS}}|{{AUDIO_CLAUSE_KEYWORDS}})

  AssetCommandName:
    match: (.+?)(?=$|[+])
    captures:
      1:
        patterns:
          - { include: "#Separator" }
          - { include: "#StringLiteral" }
          - { include: "#AssetCommandKeywordNone" }
          - { include: "#AssetCommandFilteredFileName" }
          - { include: "#AssetCommandFileName" }
          - { include: "#AssetCommandFilter" }
          - { include: "#IllegalChar" }

  AssetCommandKeywordNone:
    tag: keyword
    name: keyword.asset.keyword.none.sd
    match: (none)

  AssetCommandFilteredFileName:
    tag: variableName
    name: variable.other.constant.asset.file.sd
    match: ({{IDENTIFIER}})((?:[~][^~\s]+)+)
    captures:
      1:
        patterns:
          - { include: "#AssetCommandFileName" }
      2:
        patterns:
          - { include: "#AssetCommandFilter" }

  AssetCommandFileName:
    tag: variableName
    name: variable.other.constant.asset.file.sd
    match: ({{IDENTIFIER}})

  AssetCommandAddOperator:
    tag: propertyName
    name: variable.other.property.add.sd
    match: ([+])

  AssetCommandFilter:
    match: ([~])($|[^~\s]+)?
    captures:
      1:
        patterns:
          - { include: "#AssetCommandFilterOperator" }
      2:
        patterns:
          - { include: "#AssetCommandFilterName" }

  AssetCommandFilterOperator:
    tag: propertyName
    name: variable.other.property.filter.sd
    match: ([~])

  AssetCommandFilterName:
    tag: variableName
    name: variable.other.constant.asset.filter.sd
    match: ([^~\s]+)

  WhitespaceAssetCommandClause:
    tag: content
    name: markup.raw.whitespace.sd
    match: ({{WS}}+)

  TimeValue:
    tag: number
    name: constant.numeric.time.sd
    match: ([-]?(?:\d*[.])?\d+)(ms|s)(?=$|{{WS}})
    captures:
      1:
        tag: number
        name: constant.numeric.time.amount.sd
      2:
        tag: number
        name: constant.numeric.time.unit.sd

  NumberValue:
    tag: number
    name: constant.numeric.number.sd
    match: ([-]?(?:\d*[.])?\d+)(?=$|{{WS}})

  NameValue:
    tag: variableName
    name: variable.other.constant.sd
    match: ({{IDENTIFIER}})(?=$|{{WS}})

  InvalidValue:
    tag: content
    name: markup.raw.text.sd
    match: (\S+)

  TextCommand:
    tag: macroName
    name: meta.text.sd
    match: ([<](?!{{WS}}))((?:\\.|[^>])*?)((?<![-])[>])
    captures:
      1:
        tag: keyword
        name: keyword.operator.expression.begin.tag.sd
      2:
        patterns:
          - { include: "#TextCommandContent" }
      3:
        tag: keyword
        name: keyword.operator.expression.end.tag.sd

  TextCommandContent:
    match: ({{WS}}*)([^ :]+)({{WS}}*)(?:([:])({{WS}}*)(.*))?
    captures:
      1:
        patterns:
          - { include: "#ExtraWhitespace" }
      2:
        patterns:
          - { include: "#TextCommandControl" }
      3:
        patterns:
          - { include: "#ExtraWhitespace" }
      4:
        patterns:
          - { include: "#ColonOperator" }
      5:
        patterns:
          - { include: "#ExtraWhitespace" }
      6:
        patterns:
          - { include: "#TextCommandArguments" }

  TextCommandControl:
    match: (.+)
    captures:
      1:
        patterns:
          - { include: "#NumericLiteral" }
          - { include: "#TextCommandControlKeyword" }

  TextCommandControlKeyword:
    tag: keyword
    name: keyword.style.control.keyword.sd
    match: (.+)

  TextCommandArguments:
    match: (.+)
    captures:
      1:
        patterns:
          - { include: "#TextCommandArgument" }

  TextCommandArgument:
    tag: meta
    name: meta.argument.sd
    begin: (?=.+$)
    patterns:
      - { include: "#Annotation" }
      - { include: "#Expression" }
    end: (?=$)|([,])
    endCaptures:
      1:
        tag: separator
        name: meta.template.expression.comma.sd

  ControlKeyword:
    tag: controlKeyword
    name: keyword.control.sd
    match: (.+)

  ########## Text ##########

  InlineTextAndLogic:
    patterns:
      - { include: "#Escape" }
      - { include: "#Divert" }
      - { include: "#Thread" }
      - { include: "#ConditionalBracedBlock" }
      - { include: "#AudioCommand" }
      - { include: "#ImageCommand" }
      - { include: "#InlineText" }

  InlineText:
    patterns:
      - { include: "#Escape" }
      - { include: "#Raw" }
      - { include: "#Styling" }
      - { include: "#Emphasis" }
      - { include: "#PlainText" }

  Escape:
    match: (?:^(\\)({{WS}})|(?<!^)(\\)({{WS}})|(\\)(\S))
    captures:
      1:
        tag: definition(escape)
        name: constant.character.escape.sd
      2:
        tag: content
        name: markup.raw.text.sd
      3:
        tag: definition(escape)
        name: constant.character.escape.sd
      4:
        tag: content
        name: markup.raw.text.sd
      5:
        tag: definition(escape)
        name: constant.character.escape.sd
      6:
        tag: content
        name: markup.raw.text.sd

  Newline:
    tag: content
    name: markup.raw.whitespace.newline.sd
    match: (\r\n|\r|\n)

  Styling:
    patterns:
      - { include: "#Glue" }
      - { include: "#TextCommand" }
      - { include: "#Underline" }
      - { include: "#BoldItalic" }
      - { include: "#Bold" }
      - { include: "#Italic" }
      - { include: "#Centered" }

  StylingMark:
    match: (.+)
    captures:
      1:
        tag: definition(content)
        name: markup.raw.text.sd

  Raw:
    tag: content
    name: markup.raw.text.sd
    begin: ([`]+)
    beginCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }
    patterns:
      - { include: "#PlainText" }
    end: (\1)|(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }

  BoldItalic:
    tag: strong
    name: markup.other.bold.sd
    begin: ([*][*])(?=[*])
    beginCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }
    patterns:
      - { include: "#Italic" }
    end: (\1)|(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }

  Bold:
    tag: strong
    name: markup.other.bold.sd
    begin: ([*][*])(?![*])
    beginCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }
    patterns:
      - { include: "#InlineTextAndLogic" }
    end: (\1)|(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }

  Italic:
    tag: emphasis
    name: markup.other.italic.sd
    begin: ([*])(?![*])
    beginCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }
    patterns:
      - { include: "#InlineTextAndLogic" }
    end: (\1)|(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }

  Underline:
    tag: link
    name: markup.other.underline.sd
    begin: ([_]+)
    beginCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }
    patterns:
      - { include: "#InlineTextAndLogic" }
    end: (\1)|(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }

  Centered:
    tag: monospace
    name: constant.character.escape.centered.sd
    begin: ([\^]+)
    beginCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }
    patterns:
      - { include: "#InlineTextAndLogic" }
    end: (\1)|(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }

  Emphasis:
    patterns:
      - { include: "#EmphasisTilde" }
      - { include: "#EmphasisColon" }

  EmphasisTilde:
    tag: quote
    name: markup.emphasis.tilde.sd
    begin: ([~][~]+)
    beginCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }
    patterns:
      - { include: "#InlineTextAndLogic" }
    end: (\1)|(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }

  EmphasisColon:
    tag: quote
    name: markup.emphasis.colon.sd
    begin: ([:][:]+)
    beginCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }
    patterns:
      - { include: "#InlineTextAndLogic" }
    end: (\1)|(?={{EOL}})
    endCaptures:
      1:
        patterns:
          - { include: "#StylingMark" }

  PlainText:
    patterns:
      - { include: "#Newline" }
      - { include: "#Space" }
      - { include: "#Word" }
      - { include: "#EmDash" }
      - { include: "#Punctuation" }

  Space:
    tag: content
    name: markup.raw.space.sd
    match: ([ ])

  Word:
    tag: content
    name: markup.raw.text.sd
    match: ({{WORD}})

  EmDash:
    tag: content
    name: markup.raw.punctuation.sd
    match: ([-][-])

  Punctuation:
    tag: content
    name: markup.raw.punctuation.sd
    match: (.)

  Other:
    tag: content
    name: markup.raw.text.sd
    match: (.)

  ########## Errors ##########

  IllegalExpression:
    tag: invalid
    name: invalid.illegal.illegal-expression.sd
    match: (.+)

  IllegalChar:
    tag: invalid
    name: invalid.illegal.illegal-char.sd
    match: (.)

  Unknown:
    tag: invalid
    name: invalid.illegal.unknown-statement.sd
    match: (.+$)
